var assert, chai, chaiThings, expect, fs, parsedError, path, rawError, sinon, sinonChai, slackNotify, slackOptions, testLevels, testTypes, winston, winstonSlack, winstonSlackClass, _;

_ = require('lodash');

fs = require('fs');

chai = require('chai');

path = require('path');

sinon = require('sinon');

sinonChai = require('sinon-chai');

chaiThings = require('chai-things');

assert = chai.assert;

expect = chai.expect;

chai.use(sinonChai);

chai.use(chaiThings);

winston = require('winston');

slackNotify = require('slack-notify');

winstonSlackClass = require('../lib');

rawError = fs.readFileSync('./test/sample_error_raw.txt', 'utf8');

parsedError = fs.readFileSync('./test/sample_error_parsed.txt', 'utf8');

slackOptions = {
  webHookUrl: 'https://hooks.slack.com/services/F0U7KcIg6wtFTmUi7ZwWDG9fmchnt2u40wEgW5xai9o4',
  channel: '#samplechannel',
  username: 'ErrorBot',
  level: 'error',
  pid: process.pid,
  app: path.basename(process.argv[1], '.js')
};

winstonSlack = new winstonSlackClass(slackOptions);

testTypes = ['normal', 'errorParsing'];

testLevels = function(levels, transport, assertMsg, testType) {
  var tests;
  tests = [];
  Object.keys(levels).forEach(function(level, index) {
    return tests.push({
      name: "" + assertMsg + " with the '" + level + "' level",
      fn: function(done) {
        var logOptions, sendOptions;
        if (testType == null) {
          testType = 'normal';
        }
        logOptions = {};
        logOptions.level = level;
        logOptions.msg = 'test message';
        logOptions.meta = {};
        if (testType === 'errorParsing') {
          logOptions.meta = {
            errorStack: rawError
          };
        }
        sendOptions = {};
        sendOptions.channel = slackOptions.channel;
        sendOptions.username = slackOptions.username;
        sendOptions.text = "*" + logOptions.msg + "*";
        if (testType === 'errorParsing') {
          sendOptions.text = "*" + logOptions.msg + "*\n" + parsedError;
        }
        return transport.log(logOptions.level, logOptions.msg, logOptions.meta, function(err) {
          var sendLastCall;
          expect(transport.log).to.have.been.calledWith(logOptions.level, logOptions.msg, logOptions.meta);
          if (testType === 'normal') {
            expect(transport.log.callCount).to.equal(index + 1);
            expect(transport.slack.send.callCount).to.equal(index + 1);
          }
          sendLastCall = transport.slack.send.lastCall;
          expect(sendLastCall.args[0].channel).to.equal(sendOptions.channel);
          expect(sendLastCall.args[0].username).to.equal(sendOptions.username);
          expect(sendLastCall.args[0].text).to.equal(sendOptions.text);
          sendLastCall.args[0].attachments[0].fields.forEach(function(field) {
            if (field != null) {
              return expect(field).to.contain.keys(['title', 'value']);
            }
          });
          return done();
        });
      }
    });
  });
  return tests;
};


/* */

describe('Winston-slack-transport', function() {
  var arrErrorParsingLevels, arrTestLevels, test, _i, _j, _len, _len1, _results;
  before(function() {
    sinon.stub(winstonSlack.slack, 'request', function(data, done) {
      return done();
    });
    sinon.spy(winstonSlack.slack, 'send');
    return sinon.spy(winstonSlack, 'log');
  });
  after(function() {
    winstonSlack.slack.request.restore();
  });
  it('Should be instance of winston-slack-transport', function(done) {
    assert.instanceOf(winstonSlack, winstonSlackClass);
    assert.isFunction(winstonSlack.log);
    return done();
  });
  it('Should throw error if webHookUrl not specified', function(done) {
    var options;
    options = _.clone(slackOptions, true);
    options.webHookUrl = void 0;
    expect(function() {
      new winstonSlackClass(options);
    }).to["throw"](Error);
    return done();
  });
  it('Should throw error if pid not specified', function(done) {
    var options;
    options = _.clone(slackOptions, true);
    options.pid = void 0;
    expect(function() {
      new winstonSlackClass(options);
    }).to["throw"](Error);
    return done();
  });
  arrTestLevels = testLevels(winston.config.npm.levels, winstonSlack, 'Should respond and pass variables');
  for (_i = 0, _len = arrTestLevels.length; _i < _len; _i++) {
    test = arrTestLevels[_i];
    it(test.name, test.fn);
  }
  arrErrorParsingLevels = testLevels(winston.config.npm.levels, winstonSlack, 'Should respond, pass variables and parse error stack', 'errorParsing');
  _results = [];
  for (_j = 0, _len1 = arrErrorParsingLevels.length; _j < _len1; _j++) {
    test = arrErrorParsingLevels[_j];
    _results.push(it(test.name, test.fn));
  }
  return _results;
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvaW5kZXguY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsa0xBQUE7O0FBQUEsQ0FBQSxHQUFjLE9BQUEsQ0FBUSxRQUFSLENBQWQsQ0FBQTs7QUFBQSxFQUNBLEdBQWMsT0FBQSxDQUFRLElBQVIsQ0FEZCxDQUFBOztBQUFBLElBRUEsR0FBYyxPQUFBLENBQVEsTUFBUixDQUZkLENBQUE7O0FBQUEsSUFHQSxHQUFjLE9BQUEsQ0FBUSxNQUFSLENBSGQsQ0FBQTs7QUFBQSxLQUlBLEdBQWMsT0FBQSxDQUFRLE9BQVIsQ0FKZCxDQUFBOztBQUFBLFNBS0EsR0FBYyxPQUFBLENBQVEsWUFBUixDQUxkLENBQUE7O0FBQUEsVUFNQSxHQUFjLE9BQUEsQ0FBUSxhQUFSLENBTmQsQ0FBQTs7QUFBQSxNQU9BLEdBQVksSUFBSSxDQUFDLE1BUGpCLENBQUE7O0FBQUEsTUFRQSxHQUFZLElBQUksQ0FBQyxNQVJqQixDQUFBOztBQUFBLElBVUksQ0FBQyxHQUFMLENBQVMsU0FBVCxDQVZBLENBQUE7O0FBQUEsSUFXSSxDQUFDLEdBQUwsQ0FBUyxVQUFULENBWEEsQ0FBQTs7QUFBQSxPQWFBLEdBQVUsT0FBQSxDQUFRLFNBQVIsQ0FiVixDQUFBOztBQUFBLFdBY0EsR0FBYyxPQUFBLENBQVEsY0FBUixDQWRkLENBQUE7O0FBQUEsaUJBZUEsR0FBb0IsT0FBQSxDQUFRLFFBQVIsQ0FmcEIsQ0FBQTs7QUFBQSxRQWlCQSxHQUFXLEVBQUUsQ0FBQyxZQUFILENBQWdCLDZCQUFoQixFQUErQyxNQUEvQyxDQWpCWCxDQUFBOztBQUFBLFdBa0JBLEdBQWMsRUFBRSxDQUFDLFlBQUgsQ0FBZ0IsZ0NBQWhCLEVBQWtELE1BQWxELENBbEJkLENBQUE7O0FBQUEsWUFzQkEsR0FDRTtBQUFBLEVBQUEsVUFBQSxFQUFZLCtFQUFaO0FBQUEsRUFDQSxPQUFBLEVBQVMsZ0JBRFQ7QUFBQSxFQUVBLFFBQUEsRUFBVSxVQUZWO0FBQUEsRUFHQSxLQUFBLEVBQU8sT0FIUDtBQUFBLEVBSUEsR0FBQSxFQUFLLE9BQU8sQ0FBQyxHQUpiO0FBQUEsRUFLQSxHQUFBLEVBQUssSUFBSSxDQUFDLFFBQUwsQ0FBYyxPQUFPLENBQUMsSUFBSyxDQUFBLENBQUEsQ0FBM0IsRUFBK0IsS0FBL0IsQ0FMTDtDQXZCRixDQUFBOztBQUFBLFlBOEJBLEdBQW1CLElBQUEsaUJBQUEsQ0FBa0IsWUFBbEIsQ0E5Qm5CLENBQUE7O0FBQUEsU0FnQ0EsR0FBWSxDQUFDLFFBQUQsRUFBVSxjQUFWLENBaENaLENBQUE7O0FBQUEsVUFrQ0EsR0FBYSxTQUFDLE1BQUQsRUFBUyxTQUFULEVBQW9CLFNBQXBCLEVBQStCLFFBQS9CLEdBQUE7QUFDWCxNQUFBLEtBQUE7QUFBQSxFQUFBLEtBQUEsR0FBUSxFQUFSLENBQUE7QUFBQSxFQUNBLE1BQU0sQ0FBQyxJQUFQLENBQVksTUFBWixDQUFtQixDQUFDLE9BQXBCLENBQTRCLFNBQUMsS0FBRCxFQUFRLEtBQVIsR0FBQTtXQUMxQixLQUFLLENBQUMsSUFBTixDQUNFO0FBQUEsTUFBQSxJQUFBLEVBQU0sRUFBQSxHQUFHLFNBQUgsR0FBYSxhQUFiLEdBQTBCLEtBQTFCLEdBQWdDLFNBQXRDO0FBQUEsTUFDQSxFQUFBLEVBQUksU0FBQyxJQUFELEdBQUE7QUFDRixZQUFBLHVCQUFBO0FBQUEsUUFBQSxJQUEyQixnQkFBM0I7QUFBQSxVQUFBLFFBQUEsR0FBVyxRQUFYLENBQUE7U0FBQTtBQUFBLFFBRUEsVUFBQSxHQUFhLEVBRmIsQ0FBQTtBQUFBLFFBR0EsVUFBVSxDQUFDLEtBQVgsR0FBbUIsS0FIbkIsQ0FBQTtBQUFBLFFBSUEsVUFBVSxDQUFDLEdBQVgsR0FBaUIsY0FKakIsQ0FBQTtBQUFBLFFBS0EsVUFBVSxDQUFDLElBQVgsR0FBa0IsRUFMbEIsQ0FBQTtBQU9BLFFBQUEsSUFBRyxRQUFBLEtBQVksY0FBZjtBQUNFLFVBQUEsVUFBVSxDQUFDLElBQVgsR0FBa0I7QUFBQSxZQUFDLFVBQUEsRUFBWSxRQUFiO1dBQWxCLENBREY7U0FQQTtBQUFBLFFBVUEsV0FBQSxHQUFjLEVBVmQsQ0FBQTtBQUFBLFFBV0EsV0FBVyxDQUFDLE9BQVosR0FBc0IsWUFBWSxDQUFDLE9BWG5DLENBQUE7QUFBQSxRQVlBLFdBQVcsQ0FBQyxRQUFaLEdBQXVCLFlBQVksQ0FBQyxRQVpwQyxDQUFBO0FBQUEsUUFhQSxXQUFXLENBQUMsSUFBWixHQUFvQixHQUFBLEdBQUcsVUFBVSxDQUFDLEdBQWQsR0FBa0IsR0FidEMsQ0FBQTtBQWVBLFFBQUEsSUFBRyxRQUFBLEtBQVksY0FBZjtBQUNFLFVBQUEsV0FBVyxDQUFDLElBQVosR0FBb0IsR0FBQSxHQUFHLFVBQVUsQ0FBQyxHQUFkLEdBQWtCLEtBQWxCLEdBQXVCLFdBQTNDLENBREY7U0FmQTtlQWtCQSxTQUFTLENBQUMsR0FBVixDQUFjLFVBQVUsQ0FBQyxLQUF6QixFQUFnQyxVQUFVLENBQUMsR0FBM0MsRUFBZ0QsVUFBVSxDQUFDLElBQTNELEVBQWlFLFNBQUMsR0FBRCxHQUFBO0FBQy9ELGNBQUEsWUFBQTtBQUFBLFVBQUEsTUFBQSxDQUFPLFNBQVMsQ0FBQyxHQUFqQixDQUFxQixDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQW5DLENBQThDLFVBQVUsQ0FBQyxLQUF6RCxFQUFnRSxVQUFVLENBQUMsR0FBM0UsRUFBZ0YsVUFBVSxDQUFDLElBQTNGLENBQUEsQ0FBQTtBQUVBLFVBQUEsSUFBRyxRQUFBLEtBQVksUUFBZjtBQUNFLFlBQUEsTUFBQSxDQUFPLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBckIsQ0FBK0IsQ0FBQyxFQUFFLENBQUMsS0FBbkMsQ0FBeUMsS0FBQSxHQUFNLENBQS9DLENBQUEsQ0FBQTtBQUFBLFlBQ0EsTUFBQSxDQUFPLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQTVCLENBQXNDLENBQUMsRUFBRSxDQUFDLEtBQTFDLENBQWdELEtBQUEsR0FBTSxDQUF0RCxDQURBLENBREY7V0FGQTtBQUFBLFVBT0EsWUFBQSxHQUFlLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBUHBDLENBQUE7QUFBQSxVQVNBLE1BQUEsQ0FBTyxZQUFZLENBQUMsSUFBSyxDQUFBLENBQUEsQ0FBRSxDQUFDLE9BQTVCLENBQW9DLENBQUMsRUFBRSxDQUFDLEtBQXhDLENBQThDLFdBQVcsQ0FBQyxPQUExRCxDQVRBLENBQUE7QUFBQSxVQVVBLE1BQUEsQ0FBTyxZQUFZLENBQUMsSUFBSyxDQUFBLENBQUEsQ0FBRSxDQUFDLFFBQTVCLENBQXFDLENBQUMsRUFBRSxDQUFDLEtBQXpDLENBQStDLFdBQVcsQ0FBQyxRQUEzRCxDQVZBLENBQUE7QUFBQSxVQVdBLE1BQUEsQ0FBTyxZQUFZLENBQUMsSUFBSyxDQUFBLENBQUEsQ0FBRSxDQUFDLElBQTVCLENBQWlDLENBQUMsRUFBRSxDQUFDLEtBQXJDLENBQTJDLFdBQVcsQ0FBQyxJQUF2RCxDQVhBLENBQUE7QUFBQSxVQWFBLFlBQVksQ0FBQyxJQUFLLENBQUEsQ0FBQSxDQUFFLENBQUMsV0FBWSxDQUFBLENBQUEsQ0FBRSxDQUFDLE1BQU0sQ0FBQyxPQUEzQyxDQUFtRCxTQUFDLEtBQUQsR0FBQTtBQUNqRCxZQUFBLElBQXFELGFBQXJEO3FCQUFBLE1BQUEsQ0FBTyxLQUFQLENBQWEsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQXpCLENBQThCLENBQUMsT0FBRCxFQUFVLE9BQVYsQ0FBOUIsRUFBQTthQURpRDtVQUFBLENBQW5ELENBYkEsQ0FBQTtpQkFnQkEsSUFBQSxDQUFBLEVBakIrRDtRQUFBLENBQWpFLEVBbkJFO01BQUEsQ0FESjtLQURGLEVBRDBCO0VBQUEsQ0FBNUIsQ0FEQSxDQUFBO0FBMENBLFNBQU8sS0FBUCxDQTNDVztBQUFBLENBbENiLENBQUE7O0FBZ0ZBO0FBQUEsS0FoRkE7O0FBQUEsUUFrRkEsQ0FBUyx5QkFBVCxFQUFvQyxTQUFBLEdBQUE7QUFFbEMsTUFBQSx5RUFBQTtBQUFBLEVBQUEsTUFBQSxDQUFPLFNBQUEsR0FBQTtBQUNMLElBQUEsS0FBSyxDQUFDLElBQU4sQ0FBVyxZQUFZLENBQUMsS0FBeEIsRUFBK0IsU0FBL0IsRUFBMEMsU0FBQyxJQUFELEVBQU8sSUFBUCxHQUFBO2FBQ3hDLElBQUEsQ0FBQSxFQUR3QztJQUFBLENBQTFDLENBQUEsQ0FBQTtBQUFBLElBRUEsS0FBSyxDQUFDLEdBQU4sQ0FBVSxZQUFZLENBQUMsS0FBdkIsRUFBOEIsTUFBOUIsQ0FGQSxDQUFBO1dBR0EsS0FBSyxDQUFDLEdBQU4sQ0FBVSxZQUFWLEVBQXdCLEtBQXhCLEVBSks7RUFBQSxDQUFQLENBQUEsQ0FBQTtBQUFBLEVBTUEsS0FBQSxDQUFNLFNBQUEsR0FBQTtBQUNKLElBQUMsWUFBWSxDQUFDLEtBQU0sQ0FBQyxPQUFPLENBQUMsT0FBN0IsQ0FBQSxDQUFBLENBREk7RUFBQSxDQUFOLENBTkEsQ0FBQTtBQUFBLEVBVUEsRUFBQSxDQUFHLCtDQUFILEVBQW9ELFNBQUMsSUFBRCxHQUFBO0FBQ2xELElBQUEsTUFBTSxDQUFDLFVBQVAsQ0FBa0IsWUFBbEIsRUFBZ0MsaUJBQWhDLENBQUEsQ0FBQTtBQUFBLElBQ0EsTUFBTSxDQUFDLFVBQVAsQ0FBa0IsWUFBWSxDQUFDLEdBQS9CLENBREEsQ0FBQTtXQUVBLElBQUEsQ0FBQSxFQUhrRDtFQUFBLENBQXBELENBVkEsQ0FBQTtBQUFBLEVBZUEsRUFBQSxDQUFHLGdEQUFILEVBQXFELFNBQUMsSUFBRCxHQUFBO0FBQ25ELFFBQUEsT0FBQTtBQUFBLElBQUEsT0FBQSxHQUFVLENBQUMsQ0FBQyxLQUFGLENBQVEsWUFBUixFQUFzQixJQUF0QixDQUFWLENBQUE7QUFBQSxJQUNBLE9BQU8sQ0FBQyxVQUFSLEdBQXFCLE1BRHJCLENBQUE7QUFBQSxJQUVBLE1BQUEsQ0FBTyxTQUFBLEdBQUE7QUFDTCxNQUFJLElBQUEsaUJBQUEsQ0FBa0IsT0FBbEIsQ0FBSixDQURLO0lBQUEsQ0FBUCxDQUdDLENBQUMsRUFBRSxDQUFDLE9BQUQsQ0FISixDQUdXLEtBSFgsQ0FGQSxDQUFBO1dBTUEsSUFBQSxDQUFBLEVBUG1EO0VBQUEsQ0FBckQsQ0FmQSxDQUFBO0FBQUEsRUF3QkEsRUFBQSxDQUFHLHlDQUFILEVBQThDLFNBQUMsSUFBRCxHQUFBO0FBQzVDLFFBQUEsT0FBQTtBQUFBLElBQUEsT0FBQSxHQUFVLENBQUMsQ0FBQyxLQUFGLENBQVEsWUFBUixFQUFzQixJQUF0QixDQUFWLENBQUE7QUFBQSxJQUNBLE9BQU8sQ0FBQyxHQUFSLEdBQWMsTUFEZCxDQUFBO0FBQUEsSUFFQSxNQUFBLENBQU8sU0FBQSxHQUFBO0FBQ0wsTUFBSSxJQUFBLGlCQUFBLENBQWtCLE9BQWxCLENBQUosQ0FESztJQUFBLENBQVAsQ0FHQyxDQUFDLEVBQUUsQ0FBQyxPQUFELENBSEosQ0FHVyxLQUhYLENBRkEsQ0FBQTtXQU1BLElBQUEsQ0FBQSxFQVA0QztFQUFBLENBQTlDLENBeEJBLENBQUE7QUFBQSxFQWlDQSxhQUFBLEdBQWdCLFVBQUEsQ0FBVyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUE5QixFQUFzQyxZQUF0QyxFQUFvRCxtQ0FBcEQsQ0FqQ2hCLENBQUE7QUFrQ0EsT0FBQSxvREFBQTs2QkFBQTtBQUNFLElBQUEsRUFBQSxDQUFHLElBQUksQ0FBQyxJQUFSLEVBQWMsSUFBSSxDQUFDLEVBQW5CLENBQUEsQ0FERjtBQUFBLEdBbENBO0FBQUEsRUFxQ0EscUJBQUEsR0FBd0IsVUFBQSxDQUFXLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQTlCLEVBQXNDLFlBQXRDLEVBQW9ELHNEQUFwRCxFQUE0RyxjQUE1RyxDQXJDeEIsQ0FBQTtBQXNDQTtPQUFBLDhEQUFBO3FDQUFBO0FBQ0Usa0JBQUEsRUFBQSxDQUFHLElBQUksQ0FBQyxJQUFSLEVBQWMsSUFBSSxDQUFDLEVBQW5CLEVBQUEsQ0FERjtBQUFBO2tCQXhDa0M7QUFBQSxDQUFwQyxDQWxGQSxDQUFBIiwiZmlsZSI6InRlc3QvaW5kZXguanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJfICAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpXG5mcyAgICAgICAgICA9IHJlcXVpcmUoJ2ZzJylcbmNoYWkgICAgICAgID0gcmVxdWlyZSgnY2hhaScpXG5wYXRoICAgICAgICA9IHJlcXVpcmUoJ3BhdGgnKVxuc2lub24gICAgICAgPSByZXF1aXJlKCdzaW5vbicpXG5zaW5vbkNoYWkgICA9IHJlcXVpcmUoJ3Npbm9uLWNoYWknKVxuY2hhaVRoaW5ncyAgPSByZXF1aXJlKCdjaGFpLXRoaW5ncycpXG5hc3NlcnQgICAgPSBjaGFpLmFzc2VydFxuZXhwZWN0ICAgID0gY2hhaS5leHBlY3RcblxuY2hhaS51c2Uoc2lub25DaGFpKVxuY2hhaS51c2UoY2hhaVRoaW5ncylcblxud2luc3RvbiA9IHJlcXVpcmUoJ3dpbnN0b24nKVxuc2xhY2tOb3RpZnkgPSByZXF1aXJlKCdzbGFjay1ub3RpZnknKVxud2luc3RvblNsYWNrQ2xhc3MgPSByZXF1aXJlKCcuLi9saWInKVxuXG5yYXdFcnJvciA9IGZzLnJlYWRGaWxlU3luYyAnLi90ZXN0L3NhbXBsZV9lcnJvcl9yYXcudHh0JywgJ3V0ZjgnXG5wYXJzZWRFcnJvciA9IGZzLnJlYWRGaWxlU3luYyAnLi90ZXN0L3NhbXBsZV9lcnJvcl9wYXJzZWQudHh0JywgJ3V0ZjgnXG5cblxuI2FsbCBvcHRpb25zIGlzIHJhbmRvbVxuc2xhY2tPcHRpb25zID1cbiAgd2ViSG9va1VybDogJ2h0dHBzOi8vaG9va3Muc2xhY2suY29tL3NlcnZpY2VzL0YwVTdLY0lnNnd0RlRtVWk3WndXREc5Zm1jaG50MnU0MHdFZ1c1eGFpOW80J1xuICBjaGFubmVsOiAnI3NhbXBsZWNoYW5uZWwnXG4gIHVzZXJuYW1lOiAnRXJyb3JCb3QnXG4gIGxldmVsOiAnZXJyb3InXG4gIHBpZDogcHJvY2Vzcy5waWRcbiAgYXBwOiBwYXRoLmJhc2VuYW1lKHByb2Nlc3MuYXJndlsxXSwgJy5qcycpXG5cbndpbnN0b25TbGFjayA9IG5ldyB3aW5zdG9uU2xhY2tDbGFzcyBzbGFja09wdGlvbnNcblxudGVzdFR5cGVzID0gWydub3JtYWwnLCdlcnJvclBhcnNpbmcnXVxuXG50ZXN0TGV2ZWxzID0gKGxldmVscywgdHJhbnNwb3J0LCBhc3NlcnRNc2csIHRlc3RUeXBlKSAtPlxuICB0ZXN0cyA9IFtdXG4gIE9iamVjdC5rZXlzKGxldmVscykuZm9yRWFjaCAobGV2ZWwsIGluZGV4KSAtPlxuICAgIHRlc3RzLnB1c2hcbiAgICAgIG5hbWU6IFwiI3thc3NlcnRNc2d9IHdpdGggdGhlICcje2xldmVsfScgbGV2ZWxcIlxuICAgICAgZm46IChkb25lKSAtPlxuICAgICAgICB0ZXN0VHlwZSA9ICdub3JtYWwnIHVubGVzcyB0ZXN0VHlwZT9cblxuICAgICAgICBsb2dPcHRpb25zID0ge31cbiAgICAgICAgbG9nT3B0aW9ucy5sZXZlbCA9IGxldmVsXG4gICAgICAgIGxvZ09wdGlvbnMubXNnID0gJ3Rlc3QgbWVzc2FnZSdcbiAgICAgICAgbG9nT3B0aW9ucy5tZXRhID0ge31cblxuICAgICAgICBpZih0ZXN0VHlwZSA9PSAnZXJyb3JQYXJzaW5nJylcbiAgICAgICAgICBsb2dPcHRpb25zLm1ldGEgPSB7ZXJyb3JTdGFjazogcmF3RXJyb3J9XG4gICAgICAgIFxuICAgICAgICBzZW5kT3B0aW9ucyA9IHt9XG4gICAgICAgIHNlbmRPcHRpb25zLmNoYW5uZWwgPSBzbGFja09wdGlvbnMuY2hhbm5lbFxuICAgICAgICBzZW5kT3B0aW9ucy51c2VybmFtZSA9IHNsYWNrT3B0aW9ucy51c2VybmFtZVxuICAgICAgICBzZW5kT3B0aW9ucy50ZXh0ID0gXCIqI3tsb2dPcHRpb25zLm1zZ30qXCJcblxuICAgICAgICBpZih0ZXN0VHlwZSA9PSAnZXJyb3JQYXJzaW5nJylcbiAgICAgICAgICBzZW5kT3B0aW9ucy50ZXh0ID0gXCIqI3tsb2dPcHRpb25zLm1zZ30qXFxuI3twYXJzZWRFcnJvcn1cIlxuXG4gICAgICAgIHRyYW5zcG9ydC5sb2cgbG9nT3B0aW9ucy5sZXZlbCwgbG9nT3B0aW9ucy5tc2csIGxvZ09wdGlvbnMubWV0YSwgKGVycikgLT5cbiAgICAgICAgICBleHBlY3QodHJhbnNwb3J0LmxvZykudG8uaGF2ZS5iZWVuLmNhbGxlZFdpdGgobG9nT3B0aW9ucy5sZXZlbCwgbG9nT3B0aW9ucy5tc2csIGxvZ09wdGlvbnMubWV0YSlcblxuICAgICAgICAgIGlmKHRlc3RUeXBlID09ICdub3JtYWwnKVxuICAgICAgICAgICAgZXhwZWN0KHRyYW5zcG9ydC5sb2cuY2FsbENvdW50KS50by5lcXVhbChpbmRleCsxKVxuICAgICAgICAgICAgZXhwZWN0KHRyYW5zcG9ydC5zbGFjay5zZW5kLmNhbGxDb3VudCkudG8uZXF1YWwoaW5kZXgrMSlcblxuICAgICAgICAgICMgZ2V0IGFyZ3MgZnJvbSBzbGFjay5zZW5kXG4gICAgICAgICAgc2VuZExhc3RDYWxsID0gdHJhbnNwb3J0LnNsYWNrLnNlbmQubGFzdENhbGxcblxuICAgICAgICAgIGV4cGVjdChzZW5kTGFzdENhbGwuYXJnc1swXS5jaGFubmVsKS50by5lcXVhbChzZW5kT3B0aW9ucy5jaGFubmVsKVxuICAgICAgICAgIGV4cGVjdChzZW5kTGFzdENhbGwuYXJnc1swXS51c2VybmFtZSkudG8uZXF1YWwoc2VuZE9wdGlvbnMudXNlcm5hbWUpXG4gICAgICAgICAgZXhwZWN0KHNlbmRMYXN0Q2FsbC5hcmdzWzBdLnRleHQpLnRvLmVxdWFsKHNlbmRPcHRpb25zLnRleHQpXG5cbiAgICAgICAgICBzZW5kTGFzdENhbGwuYXJnc1swXS5hdHRhY2htZW50c1swXS5maWVsZHMuZm9yRWFjaCAoZmllbGQpIC0+XG4gICAgICAgICAgICBleHBlY3QoZmllbGQpLnRvLmNvbnRhaW4ua2V5cyhbJ3RpdGxlJywgJ3ZhbHVlJ10pIGlmIGZpZWxkP1xuXG4gICAgICAgICAgZG9uZSgpXG5cbiAgcmV0dXJuIHRlc3RzXG5cblxuIyMjICMjI1xuIyBURVNUU1xuZGVzY3JpYmUgJ1dpbnN0b24tc2xhY2stdHJhbnNwb3J0JywgKCkgLT5cblxuICBiZWZvcmUgLT5cbiAgICBzaW5vbi5zdHViIHdpbnN0b25TbGFjay5zbGFjaywgJ3JlcXVlc3QnLCAoZGF0YSwgZG9uZSkgLT5cbiAgICAgIGRvbmUoKVxuICAgIHNpbm9uLnNweSB3aW5zdG9uU2xhY2suc2xhY2ssICdzZW5kJ1xuICAgIHNpbm9uLnNweSB3aW5zdG9uU2xhY2ssICdsb2cnXG5cbiAgYWZ0ZXIgLT5cbiAgICAod2luc3RvblNsYWNrLnNsYWNrKS5yZXF1ZXN0LnJlc3RvcmUoKVxuICAgIHJldHVyblxuXG4gIGl0ICdTaG91bGQgYmUgaW5zdGFuY2Ugb2Ygd2luc3Rvbi1zbGFjay10cmFuc3BvcnQnLCAoZG9uZSkgLT5cbiAgICBhc3NlcnQuaW5zdGFuY2VPZiB3aW5zdG9uU2xhY2ssIHdpbnN0b25TbGFja0NsYXNzXG4gICAgYXNzZXJ0LmlzRnVuY3Rpb24gd2luc3RvblNsYWNrLmxvZ1xuICAgIGRvbmUoKVxuXG4gIGl0ICdTaG91bGQgdGhyb3cgZXJyb3IgaWYgd2ViSG9va1VybCBub3Qgc3BlY2lmaWVkJywgKGRvbmUpIC0+XG4gICAgb3B0aW9ucyA9IF8uY2xvbmUoc2xhY2tPcHRpb25zLCB0cnVlKVxuICAgIG9wdGlvbnMud2ViSG9va1VybCA9IHVuZGVmaW5lZFxuICAgIGV4cGVjdCgoKS0+XG4gICAgICBuZXcgd2luc3RvblNsYWNrQ2xhc3Mob3B0aW9ucylcbiAgICAgIHJldHVyblxuICAgICkudG8udGhyb3coRXJyb3IpXG4gICAgZG9uZSgpXG5cbiAgaXQgJ1Nob3VsZCB0aHJvdyBlcnJvciBpZiBwaWQgbm90IHNwZWNpZmllZCcsIChkb25lKSAtPlxuICAgIG9wdGlvbnMgPSBfLmNsb25lKHNsYWNrT3B0aW9ucywgdHJ1ZSlcbiAgICBvcHRpb25zLnBpZCA9IHVuZGVmaW5lZFxuICAgIGV4cGVjdCgoKS0+XG4gICAgICBuZXcgd2luc3RvblNsYWNrQ2xhc3Mob3B0aW9ucylcbiAgICAgIHJldHVyblxuICAgICkudG8udGhyb3coRXJyb3IpXG4gICAgZG9uZSgpXG5cbiAgYXJyVGVzdExldmVscyA9IHRlc3RMZXZlbHMgd2luc3Rvbi5jb25maWcubnBtLmxldmVscywgd2luc3RvblNsYWNrLCAnU2hvdWxkIHJlc3BvbmQgYW5kIHBhc3MgdmFyaWFibGVzJ1xuICBmb3IgdGVzdCBpbiBhcnJUZXN0TGV2ZWxzXG4gICAgaXQgdGVzdC5uYW1lLCB0ZXN0LmZuXG5cbiAgYXJyRXJyb3JQYXJzaW5nTGV2ZWxzID0gdGVzdExldmVscyB3aW5zdG9uLmNvbmZpZy5ucG0ubGV2ZWxzLCB3aW5zdG9uU2xhY2ssICdTaG91bGQgcmVzcG9uZCwgcGFzcyB2YXJpYWJsZXMgYW5kIHBhcnNlIGVycm9yIHN0YWNrJywgJ2Vycm9yUGFyc2luZydcbiAgZm9yIHRlc3QgaW4gYXJyRXJyb3JQYXJzaW5nTGV2ZWxzXG4gICAgaXQgdGVzdC5uYW1lLCB0ZXN0LmZuXG5cbiJdfQ==