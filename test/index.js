var assert, chai, chaiThings, errorParsingLevels, expect, fs, parsedError, path, rawError, sinon, sinonChai, slackNotify, slackOptions, testLevels, winston, winstonSlack, winstonSlackClass, _;

_ = require('lodash');

fs = require('fs');

chai = require('chai');

path = require('path');

sinon = require('sinon');

sinonChai = require('sinon-chai');

chaiThings = require('chai-things');

assert = chai.assert;

expect = chai.expect;

chai.use(sinonChai);

chai.use(chaiThings);

winston = require('winston');

slackNotify = require('slack-notify');

winstonSlackClass = require('../lib');

rawError = fs.readFileSync('./test/sample_error_raw.txt', 'utf8');

parsedError = fs.readFileSync('./test/sample_error_parsed.txt', 'utf8');

slackOptions = {
  webHookUrl: 'https://hooks.slack.com/services/F0U7KcIg6wtFTmUi7ZwWDG9fmchnt2u40wEgW5xai9o4',
  channel: '#samplechannel',
  username: 'ErrorBot',
  level: 'error',
  pid: process.pid,
  app: path.basename(process.argv[1], '.js')
};

winstonSlack = new winstonSlackClass(slackOptions);

testLevels = function(levels, transport, assertMsg) {
  var tests;
  tests = [];
  Object.keys(levels).forEach(function(level, index) {
    return tests.push({
      name: "" + assertMsg + " with the '" + level + "' level",
      fn: function(done) {
        var logOptions, sendOptions;
        logOptions = {};
        logOptions.level = level;
        logOptions.msg = 'test message';
        logOptions.meta = {};
        sendOptions = {
          channel: slackOptions.channel,
          username: slackOptions.username,
          text: "*" + logOptions.msg + "*"
        };
        return transport.log(logOptions.level, logOptions.msg, logOptions.meta, function(err) {
          var sendLastCall;
          expect(transport.log).to.have.been.calledWith(logOptions.level, logOptions.msg, logOptions.meta);
          expect(transport.log.callCount).to.equal(index + 1);
          expect(transport.slack.send.callCount).to.equal(index + 1);
          sendLastCall = transport.slack.send.lastCall;
          expect(sendLastCall.args[0].channel).to.equal(sendOptions.channel);
          expect(sendLastCall.args[0].username).to.equal(sendOptions.username);
          expect(sendLastCall.args[0].text).to.equal(sendOptions.text);
          sendLastCall.args[0].attachments[0].fields.forEach(function(field) {
            if (field != null) {
              return expect(field).to.contain.keys(['title', 'value']);
            }
          });
          return done();
        });
      }
    });
  });
  return tests;
};

errorParsingLevels = function(levels, transport, assertMsg) {
  var tests;
  tests = [];
  Object.keys(levels).forEach(function(level, index) {
    return tests.push({
      name: "" + assertMsg + " with the '" + level + "' level",
      fn: function(done) {
        var logOptions, sendOptions;
        logOptions = {};
        logOptions.level = level;
        logOptions.msg = 'test message';
        logOptions.meta = {
          errorStack: rawError
        };
        sendOptions = {
          channel: slackOptions.channel,
          username: slackOptions.username,
          text: "*" + logOptions.msg + "*\n" + parsedError
        };
        return transport.log(logOptions.level, logOptions.msg, logOptions.meta, function(err) {
          var sendLastCall;
          expect(transport.log).to.have.been.calledWith(logOptions.level, logOptions.msg, logOptions.meta);
          sendLastCall = transport.slack.send.lastCall;
          expect(sendLastCall.args[0].channel).to.equal(sendOptions.channel);
          expect(sendLastCall.args[0].username).to.equal(sendOptions.username);
          expect(sendLastCall.args[0].text).to.equal(sendOptions.text);
          sendLastCall.args[0].attachments[0].fields.forEach(function(field) {
            if (field != null) {
              return expect(field).to.contain.keys(['title', 'value']);
            }
          });
          return done();
        });
      }
    });
  });
  return tests;
};


/* */

describe('Winston-slack-transport', function() {
  var arrErrorParsingLevels, arrTestLevels, test, _i, _j, _len, _len1, _results;
  before(function() {
    sinon.stub(winstonSlack.slack, 'request', function(data, done) {
      return done();
    });
    sinon.spy(winstonSlack.slack, 'send');
    return sinon.spy(winstonSlack, 'log');
  });
  after(function() {
    winstonSlack.slack.request.restore();
  });
  it('Should be instance of winston-slack-transport', function(done) {
    assert.instanceOf(winstonSlack, winstonSlackClass);
    assert.isFunction(winstonSlack.log);
    return done();
  });
  it('Should throw error if webHookUrl not specified', function(done) {
    var options;
    options = _.clone(slackOptions, true);
    options.webHookUrl = void 0;
    expect(function() {
      new winstonSlackClass(options);
    }).to["throw"](Error);
    return done();
  });
  it('Should throw error if pid not specified', function(done) {
    var options;
    options = _.clone(slackOptions, true);
    options.pid = void 0;
    expect(function() {
      new winstonSlackClass(options);
    }).to["throw"](Error);
    return done();
  });
  arrTestLevels = testLevels(winston.config.npm.levels, winstonSlack, 'Should respond and pass variables');
  for (_i = 0, _len = arrTestLevels.length; _i < _len; _i++) {
    test = arrTestLevels[_i];
    it(test.name, test.fn);
  }
  arrErrorParsingLevels = errorParsingLevels(winston.config.npm.levels, winstonSlack, 'Should respond, pass variables and parse error stack');
  _results = [];
  for (_j = 0, _len1 = arrErrorParsingLevels.length; _j < _len1; _j++) {
    test = arrErrorParsingLevels[_j];
    _results.push(it(test.name, test.fn));
  }
  return _results;
});

//# sourceMappingURL=data:application/json;base64,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LElBQUEsRUFBQSxDQUFHLElBQUksQ0FBQyxJQUFSLEVBQWMsSUFBSSxDQUFDLEVBQW5CLENBQUEsQ0FERjtBQUFBLEdBbENBO0FBQUEsRUFxQ0EscUJBQUEsR0FBd0Isa0JBQUEsQ0FBbUIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsTUFBdEMsRUFBOEMsWUFBOUMsRUFBNEQsc0RBQTVELENBckN4QixDQUFBO0FBc0NBO09BQUEsOERBQUE7cUNBQUE7QUFDRSxrQkFBQSxFQUFBLENBQUcsSUFBSSxDQUFDLElBQVIsRUFBYyxJQUFJLENBQUMsRUFBbkIsRUFBQSxDQURGO0FBQUE7a0JBeENrQztBQUFBLENBQXBDLENBMUdBLENBQUEiLCJmaWxlIjoidGVzdC9pbmRleC5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbIl8gICAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJylcbmZzICAgICAgICAgID0gcmVxdWlyZSgnZnMnKVxuY2hhaSAgICAgICAgPSByZXF1aXJlKCdjaGFpJylcbnBhdGggICAgICAgID0gcmVxdWlyZSgncGF0aCcpXG5zaW5vbiAgICAgICA9IHJlcXVpcmUoJ3Npbm9uJylcbnNpbm9uQ2hhaSAgID0gcmVxdWlyZSgnc2lub24tY2hhaScpXG5jaGFpVGhpbmdzICA9IHJlcXVpcmUoJ2NoYWktdGhpbmdzJylcbmFzc2VydCAgICA9IGNoYWkuYXNzZXJ0XG5leHBlY3QgICAgPSBjaGFpLmV4cGVjdFxuXG5jaGFpLnVzZShzaW5vbkNoYWkpXG5jaGFpLnVzZShjaGFpVGhpbmdzKVxuXG53aW5zdG9uID0gcmVxdWlyZSgnd2luc3RvbicpXG5zbGFja05vdGlmeSA9IHJlcXVpcmUoJ3NsYWNrLW5vdGlmeScpXG53aW5zdG9uU2xhY2tDbGFzcyA9IHJlcXVpcmUoJy4uL2xpYicpXG5cbnJhd0Vycm9yID0gZnMucmVhZEZpbGVTeW5jICcuL3Rlc3Qvc2FtcGxlX2Vycm9yX3Jhdy50eHQnLCAndXRmOCdcbnBhcnNlZEVycm9yID0gZnMucmVhZEZpbGVTeW5jICcuL3Rlc3Qvc2FtcGxlX2Vycm9yX3BhcnNlZC50eHQnLCAndXRmOCdcblxuXG4jYWxsIG9wdGlvbnMgaXMgcmFuZG9tXG5zbGFja09wdGlvbnMgPVxuICB3ZWJIb29rVXJsOiAnaHR0cHM6Ly9ob29rcy5zbGFjay5jb20vc2VydmljZXMvRjBVN0tjSWc2d3RGVG1VaTdad1dERzlmbWNobnQydTQwd0VnVzV4YWk5bzQnXG4gIGNoYW5uZWw6ICcjc2FtcGxlY2hhbm5lbCdcbiAgdXNlcm5hbWU6ICdFcnJvckJvdCdcbiAgbGV2ZWw6ICdlcnJvcidcbiAgcGlkOiBwcm9jZXNzLnBpZFxuICBhcHA6IHBhdGguYmFzZW5hbWUocHJvY2Vzcy5hcmd2WzFdLCAnLmpzJylcblxud2luc3RvblNsYWNrID0gbmV3IHdpbnN0b25TbGFja0NsYXNzIHNsYWNrT3B0aW9uc1xuXG5cbnRlc3RMZXZlbHMgPSAobGV2ZWxzLCB0cmFuc3BvcnQsIGFzc2VydE1zZykgLT5cbiAgdGVzdHMgPSBbXVxuICBPYmplY3Qua2V5cyhsZXZlbHMpLmZvckVhY2ggKGxldmVsLCBpbmRleCkgLT5cbiAgICB0ZXN0cy5wdXNoXG4gICAgICBuYW1lOiBcIiN7YXNzZXJ0TXNnfSB3aXRoIHRoZSAnI3tsZXZlbH0nIGxldmVsXCJcbiAgICAgIGZuOiAoZG9uZSkgLT5cbiAgICAgICAgbG9nT3B0aW9ucyA9IHt9XG4gICAgICAgIGxvZ09wdGlvbnMubGV2ZWwgPSBsZXZlbFxuICAgICAgICBsb2dPcHRpb25zLm1zZyA9ICd0ZXN0IG1lc3NhZ2UnXG4gICAgICAgIGxvZ09wdGlvbnMubWV0YSA9IHt9XG5cbiAgICAgICAgc2VuZE9wdGlvbnMgPVxuICAgICAgICAgIGNoYW5uZWw6IHNsYWNrT3B0aW9ucy5jaGFubmVsXG4gICAgICAgICAgdXNlcm5hbWU6IHNsYWNrT3B0aW9ucy51c2VybmFtZVxuICAgICAgICAgIHRleHQ6IFwiKiN7bG9nT3B0aW9ucy5tc2d9KlwiXG5cbiAgICAgICAgdHJhbnNwb3J0LmxvZyBsb2dPcHRpb25zLmxldmVsLCBsb2dPcHRpb25zLm1zZywgbG9nT3B0aW9ucy5tZXRhLCAoZXJyKSAtPlxuICAgICAgICAgIGV4cGVjdCh0cmFuc3BvcnQubG9nKS50by5oYXZlLmJlZW4uY2FsbGVkV2l0aChsb2dPcHRpb25zLmxldmVsLCBsb2dPcHRpb25zLm1zZywgbG9nT3B0aW9ucy5tZXRhKVxuICAgICAgICAgIGV4cGVjdCh0cmFuc3BvcnQubG9nLmNhbGxDb3VudCkudG8uZXF1YWwoaW5kZXgrMSlcbiAgICAgICAgICBleHBlY3QodHJhbnNwb3J0LnNsYWNrLnNlbmQuY2FsbENvdW50KS50by5lcXVhbChpbmRleCsxKVxuXG4gICAgICAgICAgIyBnZXQgYXJncyBmcm9tIHNsYWNrLnNlbmRcbiAgICAgICAgICBzZW5kTGFzdENhbGwgPSB0cmFuc3BvcnQuc2xhY2suc2VuZC5sYXN0Q2FsbFxuXG4gICAgICAgICAgZXhwZWN0KHNlbmRMYXN0Q2FsbC5hcmdzWzBdLmNoYW5uZWwpLnRvLmVxdWFsKHNlbmRPcHRpb25zLmNoYW5uZWwpXG4gICAgICAgICAgZXhwZWN0KHNlbmRMYXN0Q2FsbC5hcmdzWzBdLnVzZXJuYW1lKS50by5lcXVhbChzZW5kT3B0aW9ucy51c2VybmFtZSlcbiAgICAgICAgICBleHBlY3Qoc2VuZExhc3RDYWxsLmFyZ3NbMF0udGV4dCkudG8uZXF1YWwoc2VuZE9wdGlvbnMudGV4dClcblxuICAgICAgICAgIHNlbmRMYXN0Q2FsbC5hcmdzWzBdLmF0dGFjaG1lbnRzWzBdLmZpZWxkcy5mb3JFYWNoIChmaWVsZCkgLT5cbiAgICAgICAgICAgIGV4cGVjdChmaWVsZCkudG8uY29udGFpbi5rZXlzKFsndGl0bGUnLCAndmFsdWUnXSkgaWYgZmllbGQ/XG5cbiAgICAgICAgICBkb25lKClcblxuICByZXR1cm4gdGVzdHNcblxuXG5lcnJvclBhcnNpbmdMZXZlbHMgPSAobGV2ZWxzLCB0cmFuc3BvcnQsIGFzc2VydE1zZykgLT5cbiAgdGVzdHMgPSBbXVxuICBPYmplY3Qua2V5cyhsZXZlbHMpLmZvckVhY2ggKGxldmVsLCBpbmRleCkgLT5cbiAgICB0ZXN0cy5wdXNoXG4gICAgICBuYW1lOiBcIiN7YXNzZXJ0TXNnfSB3aXRoIHRoZSAnI3tsZXZlbH0nIGxldmVsXCJcbiAgICAgIGZuOiAoZG9uZSkgLT5cbiAgICAgICAgbG9nT3B0aW9ucyA9IHt9XG4gICAgICAgIGxvZ09wdGlvbnMubGV2ZWwgPSBsZXZlbFxuICAgICAgICBsb2dPcHRpb25zLm1zZyA9ICd0ZXN0IG1lc3NhZ2UnXG4gICAgICAgIGxvZ09wdGlvbnMubWV0YSA9IHtlcnJvclN0YWNrOiByYXdFcnJvcn1cblxuICAgICAgICBzZW5kT3B0aW9ucyA9XG4gICAgICAgICAgY2hhbm5lbDogc2xhY2tPcHRpb25zLmNoYW5uZWxcbiAgICAgICAgICB1c2VybmFtZTogc2xhY2tPcHRpb25zLnVzZXJuYW1lXG4gICAgICAgICAgdGV4dDogXCIqI3tsb2dPcHRpb25zLm1zZ30qXFxuI3twYXJzZWRFcnJvcn1cIlxuXG5cbiAgICAgICAgdHJhbnNwb3J0LmxvZyBsb2dPcHRpb25zLmxldmVsLCBsb2dPcHRpb25zLm1zZywgbG9nT3B0aW9ucy5tZXRhLCAoZXJyKSAtPlxuICAgICAgICAgIGV4cGVjdCh0cmFuc3BvcnQubG9nKS50by5oYXZlLmJlZW4uY2FsbGVkV2l0aChsb2dPcHRpb25zLmxldmVsLCBsb2dPcHRpb25zLm1zZywgbG9nT3B0aW9ucy5tZXRhKVxuXG4gICAgICAgICAgIyBnZXQgYXJncyBmcm9tIHNsYWNrLnNlbmRcbiAgICAgICAgICBzZW5kTGFzdENhbGwgPSB0cmFuc3BvcnQuc2xhY2suc2VuZC5sYXN0Q2FsbFxuXG4gICAgICAgICAgZXhwZWN0KHNlbmRMYXN0Q2FsbC5hcmdzWzBdLmNoYW5uZWwpLnRvLmVxdWFsKHNlbmRPcHRpb25zLmNoYW5uZWwpXG4gICAgICAgICAgZXhwZWN0KHNlbmRMYXN0Q2FsbC5hcmdzWzBdLnVzZXJuYW1lKS50by5lcXVhbChzZW5kT3B0aW9ucy51c2VybmFtZSlcbiAgICAgICAgICBleHBlY3Qoc2VuZExhc3RDYWxsLmFyZ3NbMF0udGV4dCkudG8uZXF1YWwoc2VuZE9wdGlvbnMudGV4dClcblxuICAgICAgICAgIHNlbmRMYXN0Q2FsbC5hcmdzWzBdLmF0dGFjaG1lbnRzWzBdLmZpZWxkcy5mb3JFYWNoIChmaWVsZCkgLT5cbiAgICAgICAgICAgIGV4cGVjdChmaWVsZCkudG8uY29udGFpbi5rZXlzKFsndGl0bGUnLCAndmFsdWUnXSkgaWYgZmllbGQ/XG5cbiAgICAgICAgICBkb25lKClcbiAgICAgICAgICBcbiAgcmV0dXJuIHRlc3RzXG5cblxuIyMjICMjI1xuIyBURVNUU1xuZGVzY3JpYmUgJ1dpbnN0b24tc2xhY2stdHJhbnNwb3J0JywgKCkgLT5cblxuICBiZWZvcmUgLT5cbiAgICBzaW5vbi5zdHViIHdpbnN0b25TbGFjay5zbGFjaywgJ3JlcXVlc3QnLCAoZGF0YSwgZG9uZSkgLT5cbiAgICAgIGRvbmUoKVxuICAgIHNpbm9uLnNweSB3aW5zdG9uU2xhY2suc2xhY2ssICdzZW5kJ1xuICAgIHNpbm9uLnNweSB3aW5zdG9uU2xhY2ssICdsb2cnXG5cbiAgYWZ0ZXIgLT5cbiAgICAod2luc3RvblNsYWNrLnNsYWNrKS5yZXF1ZXN0LnJlc3RvcmUoKVxuICAgIHJldHVyblxuXG4gIGl0ICdTaG91bGQgYmUgaW5zdGFuY2Ugb2Ygd2luc3Rvbi1zbGFjay10cmFuc3BvcnQnLCAoZG9uZSkgLT5cbiAgICBhc3NlcnQuaW5zdGFuY2VPZiB3aW5zdG9uU2xhY2ssIHdpbnN0b25TbGFja0NsYXNzXG4gICAgYXNzZXJ0LmlzRnVuY3Rpb24gd2luc3RvblNsYWNrLmxvZ1xuICAgIGRvbmUoKVxuXG4gIGl0ICdTaG91bGQgdGhyb3cgZXJyb3IgaWYgd2ViSG9va1VybCBub3Qgc3BlY2lmaWVkJywgKGRvbmUpIC0+XG4gICAgb3B0aW9ucyA9IF8uY2xvbmUoc2xhY2tPcHRpb25zLCB0cnVlKVxuICAgIG9wdGlvbnMud2ViSG9va1VybCA9IHVuZGVmaW5lZFxuICAgIGV4cGVjdCgoKS0+XG4gICAgICBuZXcgd2luc3RvblNsYWNrQ2xhc3Mob3B0aW9ucylcbiAgICAgIHJldHVyblxuICAgICkudG8udGhyb3coRXJyb3IpXG4gICAgZG9uZSgpXG5cbiAgaXQgJ1Nob3VsZCB0aHJvdyBlcnJvciBpZiBwaWQgbm90IHNwZWNpZmllZCcsIChkb25lKSAtPlxuICAgIG9wdGlvbnMgPSBfLmNsb25lKHNsYWNrT3B0aW9ucywgdHJ1ZSlcbiAgICBvcHRpb25zLnBpZCA9IHVuZGVmaW5lZFxuICAgIGV4cGVjdCgoKS0+XG4gICAgICBuZXcgd2luc3RvblNsYWNrQ2xhc3Mob3B0aW9ucylcbiAgICAgIHJldHVyblxuICAgICkudG8udGhyb3coRXJyb3IpXG4gICAgZG9uZSgpXG5cbiAgYXJyVGVzdExldmVscyA9IHRlc3RMZXZlbHMgd2luc3Rvbi5jb25maWcubnBtLmxldmVscywgd2luc3RvblNsYWNrLCAnU2hvdWxkIHJlc3BvbmQgYW5kIHBhc3MgdmFyaWFibGVzJ1xuICBmb3IgdGVzdCBpbiBhcnJUZXN0TGV2ZWxzXG4gICAgaXQgdGVzdC5uYW1lLCB0ZXN0LmZuXG5cbiAgYXJyRXJyb3JQYXJzaW5nTGV2ZWxzID0gZXJyb3JQYXJzaW5nTGV2ZWxzIHdpbnN0b24uY29uZmlnLm5wbS5sZXZlbHMsIHdpbnN0b25TbGFjaywgJ1Nob3VsZCByZXNwb25kLCBwYXNzIHZhcmlhYmxlcyBhbmQgcGFyc2UgZXJyb3Igc3RhY2snXG4gIGZvciB0ZXN0IGluIGFyckVycm9yUGFyc2luZ0xldmVsc1xuICAgIGl0IHRlc3QubmFtZSwgdGVzdC5mblxuXG4iXX0=