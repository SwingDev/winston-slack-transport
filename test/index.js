var _, assert, chai, expect, fs, parsedError, path, rawError, sandbox, sinon, sinonChai, slackOptions, testLevels, testTypes, winston, winstonSlack, winstonSlackClass;

_ = require('lodash');

fs = require('fs');

chai = require('chai');

path = require('path');

sinon = require('sinon');

sinonChai = require('sinon-chai');

assert = chai.assert;

expect = chai.expect;

chai.use(sinonChai);

winston = require('winston');

winstonSlackClass = require('../lib');

rawError = fs.readFileSync('./test/sample_error_raw.txt', 'utf8');

parsedError = fs.readFileSync('./test/sample_error_parsed.txt', 'utf8');

//all options is random
slackOptions = {
  webHookUrl: 'https://hooks.slack.com/services/F0U7KcIg6wtFTmUi7ZwWDG9fmchnt2u40wEgW5xai9o4',
  channel: '#samplechannel',
  username: 'ErrorBot',
  level: 'error',
  pid: process.pid,
  app: path.basename(process.argv[1], '.js')
};

winstonSlack = new winstonSlackClass(slackOptions);

testTypes = ['normal', 'errorParsing'];

testLevels = function(levels, transport, assertMsg, testType) {
  var tests;
  tests = [];
  Object.keys(levels).forEach(function(level, index) {
    return tests.push({
      name: `${assertMsg} with the '${level}' level`,
      fn: function(done) {
        var logOptions, sendOptions;
        if (testType == null) {
          testType = 'normal';
        }
        logOptions = {};
        logOptions.level = level;
        logOptions.msg = 'test message';
        logOptions.meta = {};
        if (testType === 'errorParsing') {
          logOptions.meta = {
            errorStack: rawError
          };
        }
        sendOptions = {};
        sendOptions.channel = slackOptions.channel;
        sendOptions.username = slackOptions.username;
        sendOptions.text = `*${logOptions.msg}*`;
        if (testType === 'errorParsing') {
          sendOptions.text = `*${logOptions.msg}*\n${parsedError}`;
        }
        return transport.log(logOptions.level, logOptions.msg, logOptions.meta, function(err) {
          var sendLastCall;
          expect(transport.log).to.have.been.calledWith(logOptions.level, logOptions.msg, logOptions.meta);
          if (testType === 'normal') {
            expect(transport.log.callCount).to.equal(index + 1);
            expect(transport.slack.send.callCount).to.equal(index + 1);
          }
          // get args from slack.send
          sendLastCall = transport.slack.send.lastCall;
          expect(sendLastCall.args[0].channel).to.equal(sendOptions.channel);
          expect(sendLastCall.args[0].username).to.equal(sendOptions.username);
          expect(sendLastCall.args[0].text).to.equal(sendOptions.text);
          sendLastCall.args[0].attachments[0].fields.forEach(function(field) {
            if (field != null) {
              return expect(field).to.contain.keys(['title', 'value']);
            }
          });
          return done();
        });
      }
    });
  });
  return tests;
};

sandbox = sinon.createSandbox();

/* */
// TESTS
describe('winston-slack-transport tests', function() {
  before(function() {
    sandbox.spy(winstonSlack.slack, 'send');
    return sandbox.spy(winstonSlack, 'log');
  });
  describe('levels tests', function() {
    var arrErrorParsingLevels, arrTestLevels, i, j, len, len1, results, test;
    before(function() {
      return sandbox.stub(winstonSlack.slack, 'request').callsFake(function(data, done) {
        return done();
      });
    });
    after(function() {
      return sandbox.restore();
    });
    //(winstonSlack.slack).request.restore()
    arrTestLevels = testLevels(winston.config.npm.levels, winstonSlack, 'Should respond and pass variables');
    for (i = 0, len = arrTestLevels.length; i < len; i++) {
      test = arrTestLevels[i];
      it(test.name, test.fn);
    }
    arrErrorParsingLevels = testLevels(winston.config.npm.levels, winstonSlack, 'Should respond, pass variables and parse error stack', 'errorParsing');
    results = [];
    for (j = 0, len1 = arrErrorParsingLevels.length; j < len1; j++) {
      test = arrErrorParsingLevels[j];
      results.push(it(test.name, test.fn));
    }
    return results;
  });
  return describe('common tests', function() {
    var response;
    response = {};
    response.body = '';
    before(function() {
      return sandbox.stub(winstonSlack.slack, 'request').callsFake(function(data, done) {
        if (response.body !== 'ok') {
          return done(new Error(response.body));
        }
        return done();
      });
    });
    after(function() {
      return winstonSlack.slack.request.restore();
    });
    it('Should be instance of winston-slack-transport', function(done) {
      assert.instanceOf(winstonSlack, winstonSlackClass);
      assert.isFunction(winstonSlack.log);
      return done();
    });
    it('Should throw error if webHookUrl not specified', function(done) {
      var options;
      options = _.clone(slackOptions, true);
      options.webHookUrl = void 0;
      expect(function() {
        new winstonSlackClass(options);
      }).to.throw(Error);
      return done();
    });
    it('Should throw error if pid not specified', function(done) {
      var options;
      options = _.clone(slackOptions, true);
      options.pid = void 0;
      expect(function() {
        new winstonSlackClass(options);
      }).to.throw(Error);
      return done();
    });
    it('Should response with "ok" if message successfully send', function(done) {
      response.body = 'ok';
      return winstonSlack.log('error', 'test message', {}, function(err, send) {
        expect(send).to.be.ok;
        return done();
      });
    });
    return it('Should response with "[ErrorSlack]" if message not send (connection problem)', function(done) {
      response.body = '[ErrorSlack]';
      return winstonSlack.log('error', 'test message', {}, function(err, send) {
        expect(send).to.not.be.ok;
        return done();
      });
    });
  });
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC9pbmRleC5qcyIsInNvdXJjZXMiOlsidGVzdC9pbmRleC5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsSUFBQSxDQUFBLEVBQUEsTUFBQSxFQUFBLElBQUEsRUFBQSxNQUFBLEVBQUEsRUFBQSxFQUFBLFdBQUEsRUFBQSxJQUFBLEVBQUEsUUFBQSxFQUFBLE9BQUEsRUFBQSxLQUFBLEVBQUEsU0FBQSxFQUFBLFlBQUEsRUFBQSxVQUFBLEVBQUEsU0FBQSxFQUFBLE9BQUEsRUFBQSxZQUFBLEVBQUE7O0FBQUEsQ0FBQSxHQUFjLE9BQUEsQ0FBUSxRQUFSOztBQUNkLEVBQUEsR0FBYyxPQUFBLENBQVEsSUFBUjs7QUFDZCxJQUFBLEdBQWMsT0FBQSxDQUFRLE1BQVI7O0FBQ2QsSUFBQSxHQUFjLE9BQUEsQ0FBUSxNQUFSOztBQUNkLEtBQUEsR0FBYyxPQUFBLENBQVEsT0FBUjs7QUFDZCxTQUFBLEdBQWMsT0FBQSxDQUFRLFlBQVI7O0FBQ2QsTUFBQSxHQUFZLElBQUksQ0FBQzs7QUFDakIsTUFBQSxHQUFZLElBQUksQ0FBQzs7QUFFakIsSUFBSSxDQUFDLEdBQUwsQ0FBUyxTQUFUOztBQUVBLE9BQUEsR0FBVSxPQUFBLENBQVEsU0FBUjs7QUFDVixpQkFBQSxHQUFvQixPQUFBLENBQVEsUUFBUjs7QUFFcEIsUUFBQSxHQUFXLEVBQUUsQ0FBQyxZQUFILENBQWdCLDZCQUFoQixFQUErQyxNQUEvQzs7QUFDWCxXQUFBLEdBQWMsRUFBRSxDQUFDLFlBQUgsQ0FBZ0IsZ0NBQWhCLEVBQWtELE1BQWxELEVBZmQ7OztBQW1CQSxZQUFBLEdBQ0U7RUFBQSxVQUFBLEVBQVksK0VBQVo7RUFDQSxPQUFBLEVBQVMsZ0JBRFQ7RUFFQSxRQUFBLEVBQVUsVUFGVjtFQUdBLEtBQUEsRUFBTyxPQUhQO0VBSUEsR0FBQSxFQUFLLE9BQU8sQ0FBQyxHQUpiO0VBS0EsR0FBQSxFQUFLLElBQUksQ0FBQyxRQUFMLENBQWMsT0FBTyxDQUFDLElBQUksQ0FBQyxD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LEVBQW1GLFFBQUEsQ0FBQyxJQUFELENBQUE7TUFDakYsUUFBUSxDQUFDLElBQVQsR0FBZ0I7YUFDaEIsWUFBWSxDQUFDLEdBQWIsQ0FBaUIsT0FBakIsRUFBMEIsY0FBMUIsRUFBMEMsQ0FBQSxDQUExQyxFQUE4QyxRQUFBLENBQUMsR0FBRCxFQUFNLElBQU4sQ0FBQTtRQUM1QyxNQUFBLENBQU8sSUFBUCxDQUFZLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7ZUFDdkIsSUFBQSxDQUFBO01BRjRDLENBQTlDO0lBRmlGLENBQW5GO0VBM0N1QixDQUF6QjtBQXpCd0MsQ0FBMUMiLCJzb3VyY2VzQ29udGVudCI6WyJfICAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpXG5mcyAgICAgICAgICA9IHJlcXVpcmUoJ2ZzJylcbmNoYWkgICAgICAgID0gcmVxdWlyZSgnY2hhaScpXG5wYXRoICAgICAgICA9IHJlcXVpcmUoJ3BhdGgnKVxuc2lub24gICAgICAgPSByZXF1aXJlKCdzaW5vbicpXG5zaW5vbkNoYWkgICA9IHJlcXVpcmUoJ3Npbm9uLWNoYWknKVxuYXNzZXJ0ICAgID0gY2hhaS5hc3NlcnRcbmV4cGVjdCAgICA9IGNoYWkuZXhwZWN0XG5cbmNoYWkudXNlKHNpbm9uQ2hhaSlcblxud2luc3RvbiA9IHJlcXVpcmUoJ3dpbnN0b24nKVxud2luc3RvblNsYWNrQ2xhc3MgPSByZXF1aXJlKCcuLi9saWInKVxuXG5yYXdFcnJvciA9IGZzLnJlYWRGaWxlU3luYyAnLi90ZXN0L3NhbXBsZV9lcnJvcl9yYXcudHh0JywgJ3V0ZjgnXG5wYXJzZWRFcnJvciA9IGZzLnJlYWRGaWxlU3luYyAnLi90ZXN0L3NhbXBsZV9lcnJvcl9wYXJzZWQudHh0JywgJ3V0ZjgnXG5cblxuI2FsbCBvcHRpb25zIGlzIHJhbmRvbVxuc2xhY2tPcHRpb25zID1cbiAgd2ViSG9va1VybDogJ2h0dHBzOi8vaG9va3Muc2xhY2suY29tL3NlcnZpY2VzL0YwVTdLY0lnNnd0RlRtVWk3WndXREc5Zm1jaG50MnU0MHdFZ1c1eGFpOW80J1xuICBjaGFubmVsOiAnI3NhbXBsZWNoYW5uZWwnXG4gIHVzZXJuYW1lOiAnRXJyb3JCb3QnXG4gIGxldmVsOiAnZXJyb3InXG4gIHBpZDogcHJvY2Vzcy5waWRcbiAgYXBwOiBwYXRoLmJhc2VuYW1lKHByb2Nlc3MuYXJndlsxXSwgJy5qcycpXG5cbndpbnN0b25TbGFjayA9IG5ldyB3aW5zdG9uU2xhY2tDbGFzcyBzbGFja09wdGlvbnNcblxudGVzdFR5cGVzID0gWydub3JtYWwnLCdlcnJvclBhcnNpbmcnXVxuXG50ZXN0TGV2ZWxzID0gKGxldmVscywgdHJhbnNwb3J0LCBhc3NlcnRNc2csIHRlc3RUeXBlKSAtPlxuICB0ZXN0cyA9IFtdXG4gIE9iamVjdC5rZXlzKGxldmVscykuZm9yRWFjaCAobGV2ZWwsIGluZGV4KSAtPlxuICAgIHRlc3RzLnB1c2hcbiAgICAgIG5hbWU6IFwiI3thc3NlcnRNc2d9IHdpdGggdGhlICcje2xldmVsfScgbGV2ZWxcIlxuICAgICAgZm46IChkb25lKSAtPlxuICAgICAgICB0ZXN0VHlwZSA9ICdub3JtYWwnIHVubGVzcyB0ZXN0VHlwZT9cblxuICAgICAgICBsb2dPcHRpb25zID0ge31cbiAgICAgICAgbG9nT3B0aW9ucy5sZXZlbCA9IGxldmVsXG4gICAgICAgIGxvZ09wdGlvbnMubXNnID0gJ3Rlc3QgbWVzc2FnZSdcbiAgICAgICAgbG9nT3B0aW9ucy5tZXRhID0ge31cblxuICAgICAgICBpZih0ZXN0VHlwZSA9PSAnZXJyb3JQYXJzaW5nJylcbiAgICAgICAgICBsb2dPcHRpb25zLm1ldGEgPSB7ZXJyb3JTdGFjazogcmF3RXJyb3J9XG4gICAgICAgIFxuICAgICAgICBzZW5kT3B0aW9ucyA9IHt9XG4gICAgICAgIHNlbmRPcHRpb25zLmNoYW5uZWwgPSBzbGFja09wdGlvbnMuY2hhbm5lbFxuICAgICAgICBzZW5kT3B0aW9ucy51c2VybmFtZSA9IHNsYWNrT3B0aW9ucy51c2VybmFtZVxuICAgICAgICBzZW5kT3B0aW9ucy50ZXh0ID0gXCIqI3tsb2dPcHRpb25zLm1zZ30qXCJcblxuICAgICAgICBpZih0ZXN0VHlwZSA9PSAnZXJyb3JQYXJzaW5nJylcbiAgICAgICAgICBzZW5kT3B0aW9ucy50ZXh0ID0gXCIqI3tsb2dPcHRpb25zLm1zZ30qXFxuI3twYXJzZWRFcnJvcn1cIlxuXG4gICAgICAgIHRyYW5zcG9ydC5sb2cgbG9nT3B0aW9ucy5sZXZlbCwgbG9nT3B0aW9ucy5tc2csIGxvZ09wdGlvbnMubWV0YSwgKGVycikgLT5cbiAgICAgICAgICBleHBlY3QodHJhbnNwb3J0LmxvZykudG8uaGF2ZS5iZWVuLmNhbGxlZFdpdGgobG9nT3B0aW9ucy5sZXZlbCwgbG9nT3B0aW9ucy5tc2csIGxvZ09wdGlvbnMubWV0YSlcblxuICAgICAgICAgIGlmKHRlc3RUeXBlID09ICdub3JtYWwnKVxuICAgICAgICAgICAgZXhwZWN0KHRyYW5zcG9ydC5sb2cuY2FsbENvdW50KS50by5lcXVhbChpbmRleCsxKVxuICAgICAgICAgICAgZXhwZWN0KHRyYW5zcG9ydC5zbGFjay5zZW5kLmNhbGxDb3VudCkudG8uZXF1YWwoaW5kZXgrMSlcblxuICAgICAgICAgICMgZ2V0IGFyZ3MgZnJvbSBzbGFjay5zZW5kXG4gICAgICAgICAgc2VuZExhc3RDYWxsID0gdHJhbnNwb3J0LnNsYWNrLnNlbmQubGFzdENhbGxcblxuICAgICAgICAgIGV4cGVjdChzZW5kTGFzdENhbGwuYXJnc1swXS5jaGFubmVsKS50by5lcXVhbChzZW5kT3B0aW9ucy5jaGFubmVsKVxuICAgICAgICAgIGV4cGVjdChzZW5kTGFzdENhbGwuYXJnc1swXS51c2VybmFtZSkudG8uZXF1YWwoc2VuZE9wdGlvbnMudXNlcm5hbWUpXG4gICAgICAgICAgZXhwZWN0KHNlbmRMYXN0Q2FsbC5hcmdzWzBdLnRleHQpLnRvLmVxdWFsKHNlbmRPcHRpb25zLnRleHQpXG5cbiAgICAgICAgICBzZW5kTGFzdENhbGwuYXJnc1swXS5hdHRhY2htZW50c1swXS5maWVsZHMuZm9yRWFjaCAoZmllbGQpIC0+XG4gICAgICAgICAgICBleHBlY3QoZmllbGQpLnRvLmNvbnRhaW4ua2V5cyhbJ3RpdGxlJywgJ3ZhbHVlJ10pIGlmIGZpZWxkP1xuXG4gICAgICAgICAgZG9uZSgpXG5cbiAgcmV0dXJuIHRlc3RzXG5cbnNhbmRib3ggPSBzaW5vbi5jcmVhdGVTYW5kYm94KClcblxuIyMjICMjI1xuIyBURVNUU1xuZGVzY3JpYmUgJ3dpbnN0b24tc2xhY2stdHJhbnNwb3J0IHRlc3RzJywgKCkgLT5cblxuICBiZWZvcmUgLT5cbiAgICBzYW5kYm94LnNweSB3aW5zdG9uU2xhY2suc2xhY2ssICdzZW5kJ1xuICAgIHNhbmRib3guc3B5IHdpbnN0b25TbGFjaywgJ2xvZydcblxuICBkZXNjcmliZSAnbGV2ZWxzIHRlc3RzJywgKCkgLT5cblxuICAgIGJlZm9yZSAtPlxuICAgICAgc2FuZGJveC5zdHViKHdpbnN0b25TbGFjay5zbGFjaywgJ3JlcXVlc3QnKS5jYWxsc0Zha2UoKGRhdGEsIGRvbmUpIC0+XG4gICAgICAgIGRvbmUoKSlcblxuICAgIGFmdGVyIC0+XG4gICAgICBzYW5kYm94LnJlc3RvcmUoKVxuICAgICAgIyh3aW5zdG9uU2xhY2suc2xhY2spLnJlcXVlc3QucmVzdG9yZSgpXG5cbiAgICBhcnJUZXN0TGV2ZWxzID0gdGVzdExldmVscyB3aW5zdG9uLmNvbmZpZy5ucG0ubGV2ZWxzLCB3aW5zdG9uU2xhY2ssICdTaG91bGQgcmVzcG9uZCBhbmQgcGFzcyB2YXJpYWJsZXMnXG4gICAgZm9yIHRlc3QgaW4gYXJyVGVzdExldmVsc1xuICAgICAgaXQgdGVzdC5uYW1lLCB0ZXN0LmZuXG5cbiAgICBhcnJFcnJvclBhcnNpbmdMZXZlbHMgPSB0ZXN0TGV2ZWxzIHdpbnN0b24uY29uZmlnLm5wbS5sZXZlbHMsIHdpbnN0b25TbGFjaywgJ1Nob3VsZCByZXNwb25kLCBwYXNzIHZhcmlhYmxlcyBhbmQgcGFyc2UgZXJyb3Igc3RhY2snLCAnZXJyb3JQYXJzaW5nJ1xuICAgIGZvciB0ZXN0IGluIGFyckVycm9yUGFyc2luZ0xldmVsc1xuICAgICAgaXQgdGVzdC5uYW1lLCB0ZXN0LmZuXG5cbiAgXG4gIGRlc2NyaWJlICdjb21tb24gdGVzdHMnLCAoKSAtPlxuXG4gICAgcmVzcG9uc2UgPSB7fVxuICAgIHJlc3BvbnNlLmJvZHkgPSAnJ1xuXG4gICAgYmVmb3JlIC0+XG4gICAgICBzYW5kYm94LnN0dWIod2luc3RvblNsYWNrLnNsYWNrLCAncmVxdWVzdCcpLmNhbGxzRmFrZSgoZGF0YSwgZG9uZSkgLT5cbiAgICAgICAgaWYgcmVzcG9uc2UuYm9keSBpc250ICdvaydcbiAgICAgICAgICByZXR1cm4gZG9uZShuZXcgRXJyb3IocmVzcG9uc2UuYm9keSkpXG4gICAgICAgIGRvbmUoKSlcblxuICAgIGFmdGVyIC0+XG4gICAgICAod2luc3RvblNsYWNrLnNsYWNrKS5yZXF1ZXN0LnJlc3RvcmUoKVxuXG4gICAgaXQgJ1Nob3VsZCBiZSBpbnN0YW5jZSBvZiB3aW5zdG9uLXNsYWNrLXRyYW5zcG9ydCcsIChkb25lKSAtPlxuICAgICAgYXNzZXJ0Lmluc3RhbmNlT2Ygd2luc3RvblNsYWNrLCB3aW5zdG9uU2xhY2tDbGFzc1xuICAgICAgYXNzZXJ0LmlzRnVuY3Rpb24gd2luc3RvblNsYWNrLmxvZ1xuICAgICAgZG9uZSgpXG5cbiAgICBpdCAnU2hvdWxkIHRocm93IGVycm9yIGlmIHdlYkhvb2tVcmwgbm90IHNwZWNpZmllZCcsIChkb25lKSAtPlxuICAgICAgb3B0aW9ucyA9IF8uY2xvbmUoc2xhY2tPcHRpb25zLCB0cnVlKVxuICAgICAgb3B0aW9ucy53ZWJIb29rVXJsID0gdW5kZWZpbmVkXG4gICAgICBleHBlY3QoKCktPlxuICAgICAgICBuZXcgd2luc3RvblNsYWNrQ2xhc3Mob3B0aW9ucylcbiAgICAgICAgcmV0dXJuXG4gICAgICApLnRvLnRocm93KEVycm9yKVxuICAgICAgZG9uZSgpXG5cbiAgICBpdCAnU2hvdWxkIHRocm93IGVycm9yIGlmIHBpZCBub3Qgc3BlY2lmaWVkJywgKGRvbmUpIC0+XG4gICAgICBvcHRpb25zID0gXy5jbG9uZShzbGFja09wdGlvbnMsIHRydWUpXG4gICAgICBvcHRpb25zLnBpZCA9IHVuZGVmaW5lZFxuICAgICAgZXhwZWN0KCgpLT5cbiAgICAgICAgbmV3IHdpbnN0b25TbGFja0NsYXNzKG9wdGlvbnMpXG4gICAgICAgIHJldHVyblxuICAgICAgKS50by50aHJvdyhFcnJvcilcbiAgICAgIGRvbmUoKVxuXG4gICAgaXQgJ1Nob3VsZCByZXNwb25zZSB3aXRoIFwib2tcIiBpZiBtZXNzYWdlIHN1Y2Nlc3NmdWxseSBzZW5kJywgKGRvbmUpIC0+XG4gICAgICByZXNwb25zZS5ib2R5ID0gJ29rJ1xuICAgICAgd2luc3RvblNsYWNrLmxvZyAnZXJyb3InLCAndGVzdCBtZXNzYWdlJywge30sIChlcnIsIHNlbmQpIC0+XG4gICAgICAgIGV4cGVjdChzZW5kKS50by5iZS5va1xuICAgICAgICBkb25lKClcbiAgICAgICAgXG4gICAgaXQgJ1Nob3VsZCByZXNwb25zZSB3aXRoIFwiW0Vycm9yU2xhY2tdXCIgaWYgbWVzc2FnZSBub3Qgc2VuZCAoY29ubmVjdGlvbiBwcm9ibGVtKScsIChkb25lKSAtPlxuICAgICAgcmVzcG9uc2UuYm9keSA9ICdbRXJyb3JTbGFja10nXG4gICAgICB3aW5zdG9uU2xhY2subG9nICdlcnJvcicsICd0ZXN0IG1lc3NhZ2UnLCB7fSwgKGVyciwgc2VuZCkgLT5cbiAgICAgICAgZXhwZWN0KHNlbmQpLnRvLm5vdC5iZS5va1xuICAgICAgICBkb25lKClcbiAgICAgICAgXG5cblxuIl19
