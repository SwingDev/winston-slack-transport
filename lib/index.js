var Slack, _, _getTimestamp, os, slackNotify, usage, util, winston;

_ = require('lodash');

util = require('util');

winston = require('winston');

slackNotify = require('slack-notify');

usage = require('usage');

os = require('os');

Slack = function(options) {
  this.webHookUrl = options.webHookUrl, this.channel = options.channel, this.username = options.username, this.level = options.level, this.pid = options.pid, this.env = options.env, this.app = options.app;
  if (!options.webHookUrl) {
    throw new Error('webHookUrl must be specified');
  }
  if (!options.pid) {
    throw new Error('pid must be specified');
  }
  this.slack = slackNotify(this.webHookUrl);
};

util.inherits(Slack, winston.Transport);

winston.transports.Slack = Slack;

Slack.prototype.log = function(level, msg, meta, cb) {
  usage.lookup(this.pid, (function(_this) {
    return function(err, stat) {
      var arrStack, errorStack, fields, jsonKey, jsonValue, metaJson, paragraph, ref, strStack, totalMem, usageCpu, usageMem, usageMemP;
      if (meta.errorStack != null) {
        errorStack = meta.errorStack.trim();
      }
      metaJson = (ref = meta.json) != null ? ref : {};
      msg = "*" + msg + "*";
      if (errorStack != null) {
        errorStack = errorStack.replace(/\r?\n|\r/g, '\n');
        arrStack = errorStack.split('\n');
        paragraph = false;
        strStack = _.map(arrStack, function(val, index) {
          val = val.trim();
          if (val.indexOf('.coffee') > -1 || index === 0) {
            return "`" + val + "`";
          } else if (!paragraph) {
            paragraph = true;
            return "```" + val;
          } else if ((arrStack[index + 1] != null) && arrStack[index + 1].indexOf('.coffee') > -1) {
            paragraph = false;
            return val + "```";
          } else if (index === arrStack.length - 1 && paragraph) {
            paragraph = false;
            return val + "```";
          } else {
            paragraph = true;
            return "" + val;
          }
        }).join('\n');
        msg += "\n" + strStack;
      }
      usageCpu = stat.cpu;
      usageMem = stat.memory / (1000 * 1000);
      totalMem = os.totalmem() / (1000 * 1000);
      usageMemP = usageMem / totalMem * 100;
      fields = [
        _this.app ? {
          title: 'AppName',
          value: _this.app,
          short: true
        } : void 0, _this.env ? {
          title: 'EnvName',
          value: _this.env,
          short: true
        } : void 0, stat != null ? {
          title: 'CPU',
          value: (usageCpu.toFixed(2)) + "%",
          short: true
        } : void 0, stat != null ? {
          title: 'MEM',
          value: (usageMem.toFixed(2)) + " / " + (totalMem.toFixed(2)) + " MB (" + (usageMemP.toFixed(2)) + "%)",
          short: true
        } : void 0, {
          title: 'Timestamp',
          value: _getTimestamp(),
          short: true
        }, level ? {
          title: 'Level',
          value: level,
          short: true
        } : void 0
      ];
      for (jsonKey in metaJson) {
        jsonValue = metaJson[jsonKey];
        fields.push({
          title: jsonKey,
          value: jsonValue,
          short: true
        });
      }
      return _this.slack.send({
        channel: _this.channel,
        username: _this.username,
        text: "" + msg,
        icon_emoji: void 0,
        attachments: [
          {
            fields: fields
          }
        ]
      }, function(err) {
        if (err) {
          return cb(err, false);
        }
        return cb(null, true);
      });
    };
  })(this));
};

_getTimestamp = function() {
  var d;
  d = new Date();
  return d.toUTCString();
};

module.exports = Slack;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL2luZGV4LmpzIiwic291cmNlcyI6WyJsaWIvaW5kZXguY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUE7O0FBQUEsQ0FBQSxHQUFjLE9BQUEsQ0FBUSxRQUFSOztBQUNkLElBQUEsR0FBYyxPQUFBLENBQVEsTUFBUjs7QUFDZCxPQUFBLEdBQWMsT0FBQSxDQUFRLFNBQVI7O0FBQ2QsV0FBQSxHQUFjLE9BQUEsQ0FBUSxjQUFSOztBQUNkLEtBQUEsR0FBYyxPQUFBLENBQVEsT0FBUjs7QUFDZCxFQUFBLEdBQWMsT0FBQSxDQUFRLElBQVI7O0FBRWQsS0FBQSxHQUFRLFNBQUMsT0FBRDtFQUNMLElBQUMsQ0FBQSxxQkFBQSxVQUFGLEVBQWMsSUFBQyxDQUFBLGtCQUFBLE9BQWYsRUFBd0IsSUFBQyxDQUFBLG1CQUFBLFFBQXpCLEVBQW1DLElBQUMsQ0FBQSxnQkFBQSxLQUFwQyxFQUEyQyxJQUFDLENBQUEsY0FBQSxHQUE1QyxFQUFpRCxJQUFDLENBQUEsY0FBQSxHQUFsRCxFQUF1RCxJQUFDLENBQUEsY0FBQTtFQUN4RCxJQUFBLENBQXVELE9BQU8sQ0FBQyxVQUEvRDtBQUFBLFVBQU0sSUFBSSxLQUFKLENBQVUsOEJBQVYsRUFBTjs7RUFDQSxJQUFBLENBQWdELE9BQU8sQ0FBQyxHQUF4RDtBQUFBLFVBQU0sSUFBSSxLQUFKLENBQVUsdUJBQVYsRUFBTjs7RUFFQSxJQUFDLENBQUEsS0FBRCxHQUFTLFdBQUEsQ0FBWSxJQUFDLENBQUEsVUFBYjtBQUxIOztBQVFSLElBQUksQ0FBQyxRQUFMLENBQWMsS0FBZCxFQUFxQixPQUFPLENBQUMsU0FBN0I7O0FBQ0EsT0FBTyxDQUFDLFVBQVUsQ0FBQyxLQUFuQixHQUEyQjs7QUFFM0IsS0FBSyxDQUFBLFNBQUUsQ0FBQSxHQUFQLEdBQWEsU0FBQyxLQUFELEVBQVEsR0FBUixFQUFhLElBQWIsRUFBbUIsRUFBbkI7RUFDWCxLQUFLLENBQUMsTUFBTixDQUFhLElBQUMsQ0FBQSxHQUFkLEVB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QSxNQUpPLEVBS1A7VUFBRSxLQUFBLEVBQU8sV0FBVDtVQUFzQixLQUFBLEVBQU8sYUFBQSxDQUFBLENBQTdCO1VBQThDLEtBQUEsRUFBTyxJQUFyRDtTQUxPLEVBTTBDLEtBQWpELEdBQUE7VUFBRSxLQUFBLEVBQU8sT0FBVDtVQUFrQixLQUFBLEVBQU8sS0FBekI7VUFBZ0MsS0FBQSxFQUFPLElBQXZDO1NBQUEsR0FBQSxNQU5POztBQVNULFdBQUEsbUJBQUE7O1FBQ0UsTUFBTSxDQUFDLElBQVAsQ0FBWTtVQUFFLEtBQUEsRUFBTyxPQUFUO1VBQWtCLEtBQUEsRUFBTyxTQUF6QjtVQUFvQyxLQUFBLEVBQU8sSUFBM0M7U0FBWjtBQURGO2FBR0EsS0FBQyxDQUFBLEtBQUssQ0FBQyxJQUFQLENBQ0U7UUFBQSxPQUFBLEVBQVksS0FBQyxDQUFBLE9BQWI7UUFDQSxRQUFBLEVBQVksS0FBQyxDQUFBLFFBRGI7UUFFQSxJQUFBLEVBQVksRUFBQSxHQUFHLEdBRmY7UUFHQSxVQUFBLEVBQVksTUFIWjtRQUlBLFdBQUEsRUFBYTtVQUNYO1lBQ0UsTUFBQSxFQUFRLE1BRFY7V0FEVztTQUpiO09BREYsRUFVRSxTQUFDLEdBQUQ7UUFDQSxJQUF5QixHQUF6QjtBQUFBLGlCQUFPLEVBQUEsQ0FBRyxHQUFILEVBQVEsS0FBUixFQUFQOztlQUNBLEVBQUEsQ0FBRyxJQUFILEVBQVMsSUFBVDtNQUZBLENBVkY7SUE5Q2lCO0VBQUEsQ0FBQSxDQUFBLENBQUEsSUFBQSxDQUFuQjtBQURXOztBQWdFYixhQUFBLEdBQWdCLFNBQUE7QUFDZCxNQUFBO0VBQUEsQ0FBQSxHQUFJLElBQUksSUFBSixDQUFBO1NBQ0osQ0FBQyxDQUFDLFdBQUYsQ0FBQTtBQUZjOztBQUtoQixNQUFNLENBQUMsT0FBUCxHQUFpQiIsInNvdXJjZXNDb250ZW50IjpbIl8gICAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJylcbnV0aWwgICAgICAgID0gcmVxdWlyZSgndXRpbCcpXG53aW5zdG9uICAgICA9IHJlcXVpcmUoJ3dpbnN0b24nKVxuc2xhY2tOb3RpZnkgPSByZXF1aXJlKCdzbGFjay1ub3RpZnknKVxudXNhZ2UgICAgICAgPSByZXF1aXJlKCd1c2FnZScpXG5vcyAgICAgICAgICA9IHJlcXVpcmUoJ29zJylcblxuU2xhY2sgPSAob3B0aW9ucykgLT5cbiAge0B3ZWJIb29rVXJsLCBAY2hhbm5lbCwgQHVzZXJuYW1lLCBAbGV2ZWwsIEBwaWQsIEBlbnYsIEBhcHB9ID0gb3B0aW9uc1xuICB0aHJvdyBuZXcgRXJyb3IoJ3dlYkhvb2tVcmwgbXVzdCBiZSBzcGVjaWZpZWQnKSB1bmxlc3Mgb3B0aW9ucy53ZWJIb29rVXJsXG4gIHRocm93IG5ldyBFcnJvcigncGlkIG11c3QgYmUgc3BlY2lmaWVkJykgdW5sZXNzIG9wdGlvbnMucGlkXG5cbiAgQHNsYWNrID0gc2xhY2tOb3RpZnkgQHdlYkhvb2tVcmxcbiAgcmV0dXJuXG5cbnV0aWwuaW5oZXJpdHMgU2xhY2ssIHdpbnN0b24uVHJhbnNwb3J0XG53aW5zdG9uLnRyYW5zcG9ydHMuU2xhY2sgPSBTbGFja1xuXG5TbGFjazo6bG9nID0gKGxldmVsLCBtc2csIG1ldGEsIGNiKSAtPlxuICB1c2FnZS5sb29rdXAgQHBpZCwgKGVyciwgc3RhdCkgPT5cbiAgICBlcnJvclN0YWNrID0gKG1ldGEuZXJyb3JTdGFjaykudHJpbSgpIGlmIG1ldGEuZXJyb3JTdGFjaz9cbiAgICBtZXRhSnNvbiA9IG1ldGEuanNvbiA/IHt9XG4gICAgbXNnID0gXCIqI3ttc2d9KlwiXG5cbiAgICBpZiBlcnJvclN0YWNrP1xuICAgICAgZXJyb3JTdGFjayA9IGVycm9yU3RhY2sucmVwbGFjZSgvXFxyP1xcbnxcXHIvZywgJ1xcbicpXG4gICAgICBhcnJTdGFjayA9IGVycm9yU3RhY2suc3BsaXQoJ1xcbicpXG5cbiAgICAgIHBhcmFncmFwaCA9IGZhbHNlXG4gICAgICBzdHJTdGFjayA9IF8ubWFwKGFyclN0YWNrLCAodmFsLCBpbmRleCkgLT5cbiAgICAgICAgdmFsID0gdmFsLnRyaW0oKVxuICAgICAgICBpZiB2YWwuaW5kZXhPZignLmNvZmZlZScpID4gLTEgb3IgaW5kZXg9PTBcbiAgICAgICAgICByZXR1cm4gXCJgI3t2YWx9YFwiXG4gICAgICAgIGVsc2UgaWYgbm90IHBhcmFncmFwaFxuICAgICAgICAgIHBhcmFncmFwaCA9IHRydWVcbiAgICAgICAgICByZXR1cm4gXCJgYGAje3ZhbH1cIlxuICAgICAgICBlbHNlIGlmIGFyclN0YWNrW2luZGV4KzFdPyBhbmQgYXJyU3RhY2tbaW5kZXgrMV0uaW5kZXhPZignLmNvZmZlZScpID4gLTFcbiAgICAgICAgICBwYXJhZ3JhcGggPSBmYWxzZVxuICAgICAgICAgIHJldHVybiBcIiN7dmFsfWBgYFwiXG4gICAgICAgIGVsc2UgaWYgaW5kZXggPT0gYXJyU3RhY2subGVuZ3RoLTEgYW5kIHBhcmFncmFwaFxuICAgICAgICAgIHBhcmFncmFwaCA9IGZhbHNlXG4gICAgICAgICAgcmV0dXJuIFwiI3t2YWx9YGBgXCJcbiAgICAgICAgZWxzZVxuICAgICAgICAgIHBhcmFncmFwaCA9IHRydWVcbiAgICAgICAgICByZXR1cm4gXCIje3ZhbH1cIlxuICAgICAgICApLmpvaW4oJ1xcbicpXG4gICAgICBtc2cgKz0gXCJcXG4je3N0clN0YWNrfVwiXG5cbiAgICB1c2FnZUNwdSA9IHN0YXQuY3B1XG4gICAgdXNhZ2VNZW0gPSBzdGF0Lm1lbW9yeSAvICgxMDAwKjEwMDApXG4gICAgdG90YWxNZW0gPSBvcy50b3RhbG1lbSgpIC8gKDEwMDAqMTAwMClcbiAgICB1c2FnZU1lbVAgPSB1c2FnZU1lbS90b3RhbE1lbSAqIDEwMFxuXG4gICAgZmllbGRzID0gW1xuICAgICAgeyB0aXRsZTogJ0FwcE5hbWUnLCB2YWx1ZTogQGFwcCwgc2hvcnQ6IHRydWUgfSBpZiBAYXBwXG4gICAgICB7IHRpdGxlOiAnRW52TmFtZScsIHZhbHVlOiBAZW52LCBzaG9ydDogdHJ1ZSB9IGlmIEBlbnZcbiAgICAgIHsgdGl0bGU6ICdDUFUnLCB2YWx1ZTogXCIje3VzYWdlQ3B1LnRvRml4ZWQoMil9JVwiLCBzaG9ydDogdHJ1ZSB9IGlmIHN0YXQ/XG4gICAgICB7IHRpdGxlOiAnTUVNJywgdmFsdWU6IFwiI3t1c2FnZU1lbS50b0ZpeGVkKDIpfSAvICN7dG90YWxNZW0udG9GaXhlZCgyKX0gTUIgKCN7dXNhZ2VNZW1QLnRvRml4ZWQoMil9JSlcIiwgc2hvcnQ6IHRydWUgfSBpZiBzdGF0P1xuICAgICAgeyB0aXRsZTogJ1RpbWVzdGFtcCcsIHZhbHVlOiBfZ2V0VGltZXN0YW1wKCksIHNob3J0OiB0cnVlIH1cbiAgICAgIHsgdGl0bGU6ICdMZXZlbCcsIHZhbHVlOiBsZXZlbCwgc2hvcnQ6IHRydWUgfSBpZiBsZXZlbFxuICAgIF1cblxuICAgIGZvciBqc29uS2V5LCBqc29uVmFsdWUgb2YgbWV0YUpzb25cbiAgICAgIGZpZWxkcy5wdXNoIHsgdGl0bGU6IGpzb25LZXksIHZhbHVlOiBqc29uVmFsdWUsIHNob3J0OiB0cnVlIH1cblxuICAgIEBzbGFjay5zZW5kXG4gICAgICBjaGFubmVsOiAgICBAY2hhbm5lbFxuICAgICAgdXNlcm5hbWU6ICAgQHVzZXJuYW1lXG4gICAgICB0ZXh0OiAgICAgICBcIiN7bXNnfVwiXG4gICAgICBpY29uX2Vtb2ppOiB1bmRlZmluZWRcbiAgICAgIGF0dGFjaG1lbnRzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBmaWVsZHM6IGZpZWxkc1xuICAgICAgICB9XG4gICAgICBdXG4gICAgLCAoZXJyKSAtPlxuICAgICAgcmV0dXJuIGNiKGVyciwgZmFsc2UpIGlmIGVyclxuICAgICAgY2IobnVsbCwgdHJ1ZSlcblxuICByZXR1cm5cblxuXG5fZ2V0VGltZXN0YW1wID0gKCkgLT5cbiAgZCA9IG5ldyBEYXRlKClcbiAgZC50b1VUQ1N0cmluZygpXG5cblxubW9kdWxlLmV4cG9ydHMgPSBTbGFja1xuIl19
