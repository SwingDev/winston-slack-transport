var Slack, os, slackNotify, usage, util, winston, _, _getTimestamp;

_ = require('lodash');

util = require('util');

winston = require('winston');

slackNotify = require('slack-notify');

usage = require('usage');

os = require('os');

Slack = function(options) {
  this.webHookUrl = options.webHookUrl, this.channel = options.channel, this.username = options.username, this.level = options.level, this.pid = options.pid, this.env = options.env, this.app = options.app;
  if (!options.webHookUrl) {
    throw new Error('webHookUrl must be specified');
  }
  if (!options.pid) {
    throw new Error('pid must be specified');
  }
  this.slack = new slackNotify(this.webHookUrl);
};

util.inherits(Slack, winston.Transport);

winston.transports.Slack = Slack;

Slack.prototype.log = function(level, msg, meta, cb) {
  usage.lookup(this.pid, (function(_this) {
    return function(err, stat) {
      var arrStack, errorStack, paragraph, strStack, totalMem, usageCpu, usageMem, usageMemP;
      if (meta.errorStack != null) {
        errorStack = meta.errorStack.trim();
      }
      msg = "*" + msg + "*";
      if (errorStack != null) {
        errorStack = errorStack.replace(/\r?\n|\r/g, '\n');
        arrStack = errorStack.split('\n');
        paragraph = false;
        strStack = _.map(arrStack, function(val, index) {
          val = val.trim();
          if (val.indexOf('.coffee') > -1 || index === 0) {
            return "`" + val + "`";
          } else if (!paragraph) {
            paragraph = true;
            return "```" + val;
          } else if ((arrStack[index + 1] != null) && arrStack[index + 1].indexOf('.coffee') > -1) {
            paragraph = false;
            return "" + val + "```";
          } else if (index === arrStack.length - 1 && paragraph) {
            paragraph = false;
            return "" + val + "```";
          } else {
            paragraph = true;
            return "" + val;
          }
        }).join('\n');
        msg += "\n" + strStack;
      }
      usageCpu = stat.cpu;
      usageMem = stat.memory / (1000 * 1000);
      totalMem = os.totalmem() / (1000 * 1000);
      usageMemP = usageMem / totalMem * 100;
      return _this.slack.send({
        channel: _this.channel,
        username: _this.username,
        text: "" + msg,
        icon_emoji: void 0,
        attachments: [
          {
            fields: [
              _this.app ? {
                title: 'AppName',
                value: _this.app,
                short: true
              } : void 0, _this.env ? {
                title: 'EnvName',
                value: _this.env,
                short: true
              } : void 0, stat != null ? {
                title: 'CPU',
                value: "" + (usageCpu.toFixed(2)) + "%",
                short: true
              } : void 0, stat != null ? {
                title: 'MEM',
                value: "" + (usageMem.toFixed(2)) + " / " + (totalMem.toFixed(2)) + " MB (" + (usageMemP.toFixed(2)) + "%)",
                short: true
              } : void 0, {
                title: 'Timestamp',
                value: _getTimestamp(),
                short: true
              }, level ? {
                title: 'Level',
                value: level,
                short: true
              } : void 0
            ]
          }
        ]
      }, function(err) {
        if (err) {
          cb(err, false);
        }
        return cb(null, true);
      });
    };
  })(this));
};

_getTimestamp = function() {
  var d;
  d = new Date();
  return d.toUTCString();
};

module.exports = Slack;

//# sourceMappingURL=data:application/json;base64,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LE9BQVQ7QUFBQSxnQkFBa0IsS0FBQSxFQUFPLEtBQXpCO0FBQUEsZ0JBQWdDLEtBQUEsRUFBTyxJQUF2QztlQUFBLEdBQUEsTUFOTTthQURWO1dBRFc7U0FKYjtPQURGLEVBaUJFLFNBQUMsR0FBRCxHQUFBO0FBQ0EsUUFBQSxJQUFrQixHQUFsQjtBQUFBLFVBQUEsRUFBQSxDQUFHLEdBQUgsRUFBUSxLQUFSLENBQUEsQ0FBQTtTQUFBO2VBQ0EsRUFBQSxDQUFHLElBQUgsRUFBUyxJQUFULEVBRkE7TUFBQSxDQWpCRixFQWpDaUI7SUFBQSxFQUFBO0VBQUEsQ0FBQSxDQUFBLENBQUEsSUFBQSxDQUFuQixDQUFBLENBRFc7QUFBQSxDQWxCYixDQUFBOztBQUFBLGFBNEVBLEdBQWdCLFNBQUEsR0FBQTtBQUNkLE1BQUEsQ0FBQTtBQUFBLEVBQUEsQ0FBQSxHQUFRLElBQUEsSUFBQSxDQUFBLENBQVIsQ0FBQTtTQUNBLENBQUMsQ0FBQyxXQUFGLENBQUEsRUFGYztBQUFBLENBNUVoQixDQUFBOztBQUFBLE1BaUZNLENBQUMsT0FBUCxHQUFpQixLQWpGakIsQ0FBQSIsImZpbGUiOiJsaWIvaW5kZXguanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJfICAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpXG51dGlsICAgICAgICA9IHJlcXVpcmUoJ3V0aWwnKVxud2luc3RvbiAgICAgPSByZXF1aXJlKCd3aW5zdG9uJylcbnNsYWNrTm90aWZ5ID0gcmVxdWlyZSgnc2xhY2stbm90aWZ5JylcbnVzYWdlICAgICAgID0gcmVxdWlyZSgndXNhZ2UnKVxub3MgICAgICAgICAgPSByZXF1aXJlKCdvcycpXG5cblNsYWNrID0gKG9wdGlvbnMpIC0+XG4gIHtAd2ViSG9va1VybCwgQGNoYW5uZWwsIEB1c2VybmFtZSwgQGxldmVsLCBAcGlkLCBAZW52LCBAYXBwfSA9IG9wdGlvbnNcbiAgdGhyb3cgbmV3IEVycm9yKCd3ZWJIb29rVXJsIG11c3QgYmUgc3BlY2lmaWVkJykgdW5sZXNzIG9wdGlvbnMud2ViSG9va1VybFxuICB0aHJvdyBuZXcgRXJyb3IoJ3BpZCBtdXN0IGJlIHNwZWNpZmllZCcpIHVubGVzcyBvcHRpb25zLnBpZFxuXG4gIEBzbGFjayA9IG5ldyBzbGFja05vdGlmeShAd2ViSG9va1VybClcbiAgcmV0dXJuXG5cbnV0aWwuaW5oZXJpdHMgU2xhY2ssIHdpbnN0b24uVHJhbnNwb3J0XG53aW5zdG9uLnRyYW5zcG9ydHMuU2xhY2sgPSBTbGFja1xuXG5TbGFjazo6bG9nID0gKGxldmVsLCBtc2csIG1ldGEsIGNiKSAtPlxuICB1c2FnZS5sb29rdXAgQHBpZCwgKGVyciwgc3RhdCkgPT5cbiAgICBlcnJvclN0YWNrID0gKG1ldGEuZXJyb3JTdGFjaykudHJpbSgpIGlmIG1ldGEuZXJyb3JTdGFjaz9cbiAgICBtc2cgPSBcIioje21zZ30qXCJcblxuICAgIGlmIGVycm9yU3RhY2s/XG4gICAgICBlcnJvclN0YWNrID0gZXJyb3JTdGFjay5yZXBsYWNlKC9cXHI/XFxufFxcci9nLCAnXFxuJylcbiAgICAgIGFyclN0YWNrID0gZXJyb3JTdGFjay5zcGxpdCgnXFxuJylcblxuICAgICAgcGFyYWdyYXBoID0gZmFsc2VcbiAgICAgIHN0clN0YWNrID0gXy5tYXAoYXJyU3RhY2ssICh2YWwsIGluZGV4KSAtPlxuICAgICAgICB2YWwgPSB2YWwudHJpbSgpXG4gICAgICAgIGlmIHZhbC5pbmRleE9mKCcuY29mZmVlJykgPiAtMSBvciBpbmRleD09MFxuICAgICAgICAgIHJldHVybiBcImAje3ZhbH1gXCJcbiAgICAgICAgZWxzZSBpZiBub3QgcGFyYWdyYXBoXG4gICAgICAgICAgcGFyYWdyYXBoID0gdHJ1ZVxuICAgICAgICAgIHJldHVybiBcImBgYCN7dmFsfVwiXG4gICAgICAgIGVsc2UgaWYgYXJyU3RhY2tbaW5kZXgrMV0/IGFuZCBhcnJTdGFja1tpbmRleCsxXS5pbmRleE9mKCcuY29mZmVlJykgPiAtMVxuICAgICAgICAgIHBhcmFncmFwaCA9IGZhbHNlXG4gICAgICAgICAgcmV0dXJuIFwiI3t2YWx9YGBgXCJcbiAgICAgICAgZWxzZSBpZiBpbmRleCA9PSBhcnJTdGFjay5sZW5ndGgtMSBhbmQgcGFyYWdyYXBoXG4gICAgICAgICAgcGFyYWdyYXBoID0gZmFsc2VcbiAgICAgICAgICByZXR1cm4gXCIje3ZhbH1gYGBcIlxuICAgICAgICBlbHNlXG4gICAgICAgICAgcGFyYWdyYXBoID0gdHJ1ZVxuICAgICAgICAgIHJldHVybiBcIiN7dmFsfVwiXG4gICAgICAgICkuam9pbignXFxuJylcbiAgICAgIG1zZyArPSBcIlxcbiN7c3RyU3RhY2t9XCJcblxuICAgIHVzYWdlQ3B1ID0gc3RhdC5jcHVcbiAgICB1c2FnZU1lbSA9IHN0YXQubWVtb3J5IC8gKDEwMDAqMTAwMClcbiAgICB0b3RhbE1lbSA9IG9zLnRvdGFsbWVtKCkgLyAoMTAwMCoxMDAwKVxuICAgIHVzYWdlTWVtUCA9IHVzYWdlTWVtL3RvdGFsTWVtICogMTAwXG5cbiAgICBAc2xhY2suc2VuZFxuICAgICAgY2hhbm5lbDogICAgQGNoYW5uZWxcbiAgICAgIHVzZXJuYW1lOiAgIEB1c2VybmFtZVxuICAgICAgdGV4dDogICAgICAgXCIje21zZ31cIlxuICAgICAgaWNvbl9lbW9qaTogdW5kZWZpbmVkXG4gICAgICBhdHRhY2htZW50czogW1xuICAgICAgICB7XG4gICAgICAgICAgZmllbGRzOiBbXG4gICAgICAgICAgICB7IHRpdGxlOiAnQXBwTmFtZScsIHZhbHVlOiBAYXBwLCBzaG9ydDogdHJ1ZSB9IGlmIEBhcHBcbiAgICAgICAgICAgIHsgdGl0bGU6ICdFbnZOYW1lJywgdmFsdWU6IEBlbnYsIHNob3J0OiB0cnVlIH0gaWYgQGVudlxuICAgICAgICAgICAgeyB0aXRsZTogJ0NQVScsIHZhbHVlOiBcIiN7dXNhZ2VDcHUudG9GaXhlZCgyKX0lXCIsIHNob3J0OiB0cnVlIH0gaWYgc3RhdD9cbiAgICAgICAgICAgIHsgdGl0bGU6ICdNRU0nLCB2YWx1ZTogXCIje3VzYWdlTWVtLnRvRml4ZWQoMil9IC8gI3t0b3RhbE1lbS50b0ZpeGVkKDIpfSBNQiAoI3t1c2FnZU1lbVAudG9GaXhlZCgyKX0lKVwiLCBzaG9ydDogdHJ1ZSB9IGlmIHN0YXQ/XG4gICAgICAgICAgICB7IHRpdGxlOiAnVGltZXN0YW1wJywgdmFsdWU6IF9nZXRUaW1lc3RhbXAoKSwgc2hvcnQ6IHRydWUgfVxuICAgICAgICAgICAgeyB0aXRsZTogJ0xldmVsJywgdmFsdWU6IGxldmVsLCBzaG9ydDogdHJ1ZSB9IGlmIGxldmVsXG4gICAgICAgICAgXVxuICAgICAgICB9XG4gICAgICBdXG4gICAgLCAoZXJyKSAtPlxuICAgICAgY2IoZXJyLCBmYWxzZSkgaWYgZXJyXG4gICAgICBjYihudWxsLCB0cnVlKVxuXG4gIHJldHVyblxuXG5cbl9nZXRUaW1lc3RhbXAgPSAoKSAtPlxuICBkID0gbmV3IERhdGUoKVxuICBkLnRvVVRDU3RyaW5nKClcblxuXG5tb2R1bGUuZXhwb3J0cyA9IFNsYWNrXG4iXX0=