var Slack, _, _getTimestamp, os, slackNotify, usage, util, winston;

_ = require('lodash');

util = require('util');

winston = require('winston');

slackNotify = require('slack-notify');

usage = require('usage');

os = require('os');

Slack = function(options) {
  this.webHookUrl = options.webHookUrl, this.channel = options.channel, this.username = options.username, this.level = options.level, this.pid = options.pid, this.env = options.env, this.app = options.app;
  if (!options.webHookUrl) {
    throw new Error('webHookUrl must be specified');
  }
  if (!options.pid) {
    throw new Error('pid must be specified');
  }
  this.slack = new slackNotify(this.webHookUrl);
};

util.inherits(Slack, winston.Transport);

winston.transports.Slack = Slack;

Slack.prototype.log = function(level, msg, meta, cb) {
  usage.lookup(this.pid, (function(_this) {
    return function(err, stat) {
      var arrStack, errorStack, fields, jsonKey, jsonValue, metaJson, paragraph, ref, strStack, totalMem, usageCpu, usageMem, usageMemP;
      if (meta.errorStack != null) {
        errorStack = meta.errorStack.trim();
      }
      metaJson = (ref = meta.json) != null ? ref : {};
      msg = "*" + msg + "*";
      if (errorStack != null) {
        errorStack = errorStack.replace(/\r?\n|\r/g, '\n');
        arrStack = errorStack.split('\n');
        paragraph = false;
        strStack = _.map(arrStack, function(val, index) {
          val = val.trim();
          if (val.indexOf('.coffee') > -1 || index === 0) {
            return "`" + val + "`";
          } else if (!paragraph) {
            paragraph = true;
            return "```" + val;
          } else if ((arrStack[index + 1] != null) && arrStack[index + 1].indexOf('.coffee') > -1) {
            paragraph = false;
            return val + "```";
          } else if (index === arrStack.length - 1 && paragraph) {
            paragraph = false;
            return val + "```";
          } else {
            paragraph = true;
            return "" + val;
          }
        }).join('\n');
        msg += "\n" + strStack;
      }
      usageCpu = stat.cpu;
      usageMem = stat.memory / (1000 * 1000);
      totalMem = os.totalmem() / (1000 * 1000);
      usageMemP = usageMem / totalMem * 100;
      fields = [
        _this.app ? {
          title: 'AppName',
          value: _this.app,
          short: true
        } : void 0, _this.env ? {
          title: 'EnvName',
          value: _this.env,
          short: true
        } : void 0, stat != null ? {
          title: 'CPU',
          value: (usageCpu.toFixed(2)) + "%",
          short: true
        } : void 0, stat != null ? {
          title: 'MEM',
          value: (usageMem.toFixed(2)) + " / " + (totalMem.toFixed(2)) + " MB (" + (usageMemP.toFixed(2)) + "%)",
          short: true
        } : void 0, {
          title: 'Timestamp',
          value: _getTimestamp(),
          short: true
        }, level ? {
          title: 'Level',
          value: level,
          short: true
        } : void 0
      ];
      for (jsonKey in metaJson) {
        jsonValue = metaJson[jsonKey];
        fields.push({
          title: jsonKey,
          value: jsonValue,
          short: true
        });
      }
      return _this.slack.send({
        channel: _this.channel,
        username: _this.username,
        text: "" + msg,
        icon_emoji: void 0,
        attachments: [
          {
            fields: fields
          }
        ]
      }, function(err) {
        if (err) {
          return cb(err, false);
        }
        return cb(null, true);
      });
    };
  })(this));
};

_getTimestamp = function() {
  var d;
  d = new Date();
  return d.toUTCString();
};

module.exports = Slack;

//# sourceMappingURL=data:application/json;base64,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S0FBQSxFQUFPLFdBQVQ7VUFBc0IsS0FBQSxFQUFPLGFBQUEsQ0FBQSxDQUE3QjtVQUE4QyxLQUFBLEVBQU8sSUFBckQ7U0FMTyxFQU0wQyxLQUFqRCxHQUFBO1VBQUUsS0FBQSxFQUFPLE9BQVQ7VUFBa0IsS0FBQSxFQUFPLEtBQXpCO1VBQWdDLEtBQUEsRUFBTyxJQUF2QztTQUFBLEdBQUEsTUFOTzs7QUFTVCxXQUFBLG1CQUFBOztRQUNFLE1BQU0sQ0FBQyxJQUFQLENBQVk7VUFBRSxLQUFBLEVBQU8sT0FBVDtVQUFrQixLQUFBLEVBQU8sU0FBekI7VUFBb0MsS0FBQSxFQUFPLElBQTNDO1NBQVo7QUFERjthQUdBLEtBQUMsQ0FBQSxLQUFLLENBQUMsSUFBUCxDQUNFO1FBQUEsT0FBQSxFQUFZLEtBQUMsQ0FBQSxPQUFiO1FBQ0EsUUFBQSxFQUFZLEtBQUMsQ0FBQSxRQURiO1FBRUEsSUFBQSxFQUFZLEVBQUEsR0FBRyxHQUZmO1FBR0EsVUFBQSxFQUFZLE1BSFo7UUFJQSxXQUFBLEVBQWE7VUFDWDtZQUNFLE1BQUEsRUFBUSxNQURWO1dBRFc7U0FKYjtPQURGLEVBVUUsU0FBQyxHQUFEO1FBQ0EsSUFBeUIsR0FBekI7QUFBQSxpQkFBTyxFQUFBLENBQUcsR0FBSCxFQUFRLEtBQVIsRUFBUDs7ZUFDQSxFQUFBLENBQUcsSUFBSCxFQUFTLElBQVQ7TUFGQSxDQVZGO0lBOUNpQjtFQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBbkI7QUFEVzs7QUFnRWIsYUFBQSxHQUFnQixTQUFBO0FBQ2QsTUFBQTtFQUFBLENBQUEsR0FBUSxJQUFBLElBQUEsQ0FBQTtTQUNSLENBQUMsQ0FBQyxXQUFGLENBQUE7QUFGYzs7QUFLaEIsTUFBTSxDQUFDLE9BQVAsR0FBaUIiLCJmaWxlIjoibGliL2luZGV4LmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiXyAgICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKVxudXRpbCAgICAgICAgPSByZXF1aXJlKCd1dGlsJylcbndpbnN0b24gICAgID0gcmVxdWlyZSgnd2luc3RvbicpXG5zbGFja05vdGlmeSA9IHJlcXVpcmUoJ3NsYWNrLW5vdGlmeScpXG51c2FnZSAgICAgICA9IHJlcXVpcmUoJ3VzYWdlJylcbm9zICAgICAgICAgID0gcmVxdWlyZSgnb3MnKVxuXG5TbGFjayA9IChvcHRpb25zKSAtPlxuICB7QHdlYkhvb2tVcmwsIEBjaGFubmVsLCBAdXNlcm5hbWUsIEBsZXZlbCwgQHBpZCwgQGVudiwgQGFwcH0gPSBvcHRpb25zXG4gIHRocm93IG5ldyBFcnJvcignd2ViSG9va1VybCBtdXN0IGJlIHNwZWNpZmllZCcpIHVubGVzcyBvcHRpb25zLndlYkhvb2tVcmxcbiAgdGhyb3cgbmV3IEVycm9yKCdwaWQgbXVzdCBiZSBzcGVjaWZpZWQnKSB1bmxlc3Mgb3B0aW9ucy5waWRcblxuICBAc2xhY2sgPSBuZXcgc2xhY2tOb3RpZnkoQHdlYkhvb2tVcmwpXG4gIHJldHVyblxuXG51dGlsLmluaGVyaXRzIFNsYWNrLCB3aW5zdG9uLlRyYW5zcG9ydFxud2luc3Rvbi50cmFuc3BvcnRzLlNsYWNrID0gU2xhY2tcblxuU2xhY2s6OmxvZyA9IChsZXZlbCwgbXNnLCBtZXRhLCBjYikgLT5cbiAgdXNhZ2UubG9va3VwIEBwaWQsIChlcnIsIHN0YXQpID0+XG4gICAgZXJyb3JTdGFjayA9IChtZXRhLmVycm9yU3RhY2spLnRyaW0oKSBpZiBtZXRhLmVycm9yU3RhY2s/XG4gICAgbWV0YUpzb24gPSBtZXRhLmpzb24gPyB7fVxuICAgIG1zZyA9IFwiKiN7bXNnfSpcIlxuXG4gICAgaWYgZXJyb3JTdGFjaz9cbiAgICAgIGVycm9yU3RhY2sgPSBlcnJvclN0YWNrLnJlcGxhY2UoL1xccj9cXG58XFxyL2csICdcXG4nKVxuICAgICAgYXJyU3RhY2sgPSBlcnJvclN0YWNrLnNwbGl0KCdcXG4nKVxuXG4gICAgICBwYXJhZ3JhcGggPSBmYWxzZVxuICAgICAgc3RyU3RhY2sgPSBfLm1hcChhcnJTdGFjaywgKHZhbCwgaW5kZXgpIC0+XG4gICAgICAgIHZhbCA9IHZhbC50cmltKClcbiAgICAgICAgaWYgdmFsLmluZGV4T2YoJy5jb2ZmZWUnKSA+IC0xIG9yIGluZGV4PT0wXG4gICAgICAgICAgcmV0dXJuIFwiYCN7dmFsfWBcIlxuICAgICAgICBlbHNlIGlmIG5vdCBwYXJhZ3JhcGhcbiAgICAgICAgICBwYXJhZ3JhcGggPSB0cnVlXG4gICAgICAgICAgcmV0dXJuIFwiYGBgI3t2YWx9XCJcbiAgICAgICAgZWxzZSBpZiBhcnJTdGFja1tpbmRleCsxXT8gYW5kIGFyclN0YWNrW2luZGV4KzFdLmluZGV4T2YoJy5jb2ZmZWUnKSA+IC0xXG4gICAgICAgICAgcGFyYWdyYXBoID0gZmFsc2VcbiAgICAgICAgICByZXR1cm4gXCIje3ZhbH1gYGBcIlxuICAgICAgICBlbHNlIGlmIGluZGV4ID09IGFyclN0YWNrLmxlbmd0aC0xIGFuZCBwYXJhZ3JhcGhcbiAgICAgICAgICBwYXJhZ3JhcGggPSBmYWxzZVxuICAgICAgICAgIHJldHVybiBcIiN7dmFsfWBgYFwiXG4gICAgICAgIGVsc2VcbiAgICAgICAgICBwYXJhZ3JhcGggPSB0cnVlXG4gICAgICAgICAgcmV0dXJuIFwiI3t2YWx9XCJcbiAgICAgICAgKS5qb2luKCdcXG4nKVxuICAgICAgbXNnICs9IFwiXFxuI3tzdHJTdGFja31cIlxuXG4gICAgdXNhZ2VDcHUgPSBzdGF0LmNwdVxuICAgIHVzYWdlTWVtID0gc3RhdC5tZW1vcnkgLyAoMTAwMCoxMDAwKVxuICAgIHRvdGFsTWVtID0gb3MudG90YWxtZW0oKSAvICgxMDAwKjEwMDApXG4gICAgdXNhZ2VNZW1QID0gdXNhZ2VNZW0vdG90YWxNZW0gKiAxMDBcblxuICAgIGZpZWxkcyA9IFtcbiAgICAgIHsgdGl0bGU6ICdBcHBOYW1lJywgdmFsdWU6IEBhcHAsIHNob3J0OiB0cnVlIH0gaWYgQGFwcFxuICAgICAgeyB0aXRsZTogJ0Vudk5hbWUnLCB2YWx1ZTogQGVudiwgc2hvcnQ6IHRydWUgfSBpZiBAZW52XG4gICAgICB7IHRpdGxlOiAnQ1BVJywgdmFsdWU6IFwiI3t1c2FnZUNwdS50b0ZpeGVkKDIpfSVcIiwgc2hvcnQ6IHRydWUgfSBpZiBzdGF0P1xuICAgICAgeyB0aXRsZTogJ01FTScsIHZhbHVlOiBcIiN7dXNhZ2VNZW0udG9GaXhlZCgyKX0gLyAje3RvdGFsTWVtLnRvRml4ZWQoMil9IE1CICgje3VzYWdlTWVtUC50b0ZpeGVkKDIpfSUpXCIsIHNob3J0OiB0cnVlIH0gaWYgc3RhdD9cbiAgICAgIHsgdGl0bGU6ICdUaW1lc3RhbXAnLCB2YWx1ZTogX2dldFRpbWVzdGFtcCgpLCBzaG9ydDogdHJ1ZSB9XG4gICAgICB7IHRpdGxlOiAnTGV2ZWwnLCB2YWx1ZTogbGV2ZWwsIHNob3J0OiB0cnVlIH0gaWYgbGV2ZWxcbiAgICBdXG5cbiAgICBmb3IganNvbktleSwganNvblZhbHVlIG9mIG1ldGFKc29uXG4gICAgICBmaWVsZHMucHVzaCB7IHRpdGxlOiBqc29uS2V5LCB2YWx1ZToganNvblZhbHVlLCBzaG9ydDogdHJ1ZSB9XG5cbiAgICBAc2xhY2suc2VuZFxuICAgICAgY2hhbm5lbDogICAgQGNoYW5uZWxcbiAgICAgIHVzZXJuYW1lOiAgIEB1c2VybmFtZVxuICAgICAgdGV4dDogICAgICAgXCIje21zZ31cIlxuICAgICAgaWNvbl9lbW9qaTogdW5kZWZpbmVkXG4gICAgICBhdHRhY2htZW50czogW1xuICAgICAgICB7XG4gICAgICAgICAgZmllbGRzOiBmaWVsZHNcbiAgICAgICAgfVxuICAgICAgXVxuICAgICwgKGVycikgLT5cbiAgICAgIHJldHVybiBjYihlcnIsIGZhbHNlKSBpZiBlcnJcbiAgICAgIGNiKG51bGwsIHRydWUpXG5cbiAgcmV0dXJuXG5cblxuX2dldFRpbWVzdGFtcCA9ICgpIC0+XG4gIGQgPSBuZXcgRGF0ZSgpXG4gIGQudG9VVENTdHJpbmcoKVxuXG5cbm1vZHVsZS5leHBvcnRzID0gU2xhY2tcbiJdfQ==