var Slack, _, _getTimestamp, os, slackNotify, usage, util, winston;

_ = require('lodash');

util = require('util');

winston = require('winston');

slackNotify = require('slack-notify');

usage = require('usage');

os = require('os');

Slack = function(options) {
  ({webHookUrl: this.webHookUrl, channel: this.channel, username: this.username, level: this.level, pid: this.pid, env: this.env, app: this.app} = options);
  if (!options.webHookUrl) {
    throw new Error('webHookUrl must be specified');
  }
  if (!options.pid) {
    throw new Error('pid must be specified');
  }
  this.slack = slackNotify(this.webHookUrl);
};

util.inherits(Slack, winston.Transport);

winston.transports.Slack = Slack;

Slack.prototype.log = function(level, msg, meta, cb) {
  usage.lookup(this.pid, (err, stat) => {
    var arrStack, errorStack, fields, jsonKey, jsonValue, metaJson, paragraph, ref, strStack, totalMem, usageCpu, usageMem, usageMemP;
    if (meta.errorStack != null) {
      errorStack = meta.errorStack.trim();
    }
    metaJson = (ref = meta.json) != null ? ref : {};
    msg = `*${msg}*`;
    if (errorStack != null) {
      errorStack = errorStack.replace(/\r?\n|\r/g, '\n');
      arrStack = errorStack.split('\n');
      paragraph = false;
      strStack = _.map(arrStack, function(val, index) {
        val = val.trim();
        if (val.indexOf('.coffee') > -1 || index === 0) {
          return `\`${val}\``;
        } else if (!paragraph) {
          paragraph = true;
          return `\`\`\`${val}`;
        } else if ((arrStack[index + 1] != null) && arrStack[index + 1].indexOf('.coffee') > -1) {
          paragraph = false;
          return `${val}\`\`\``;
        } else if (index === arrStack.length - 1 && paragraph) {
          paragraph = false;
          return `${val}\`\`\``;
        } else {
          paragraph = true;
          return `${val}`;
        }
      }).join('\n');
      msg += `\n${strStack}`;
    }
    usageCpu = stat.cpu;
    usageMem = stat.memory / (1000 * 1000);
    totalMem = os.totalmem() / (1000 * 1000);
    usageMemP = usageMem / totalMem * 100;
    fields = [
      this.app ? {
        title: 'AppName',
        value: this.app,
        short: true
      } : void 0,
      this.env ? {
        title: 'EnvName',
        value: this.env,
        short: true
      } : void 0,
      stat != null ? {
        title: 'CPU',
        value: `${usageCpu.toFixed(2)}%`,
        short: true
      } : void 0,
      stat != null ? {
        title: 'MEM',
        value: `${usageMem.toFixed(2)} / ${totalMem.toFixed(2)} MB (${usageMemP.toFixed(2)}%)`,
        short: true
      } : void 0,
      {
        title: 'Timestamp',
        value: _getTimestamp(),
        short: true
      },
      level ? {
        title: 'Level',
        value: level,
        short: true
      } : void 0
    ];
    for (jsonKey in metaJson) {
      jsonValue = metaJson[jsonKey];
      fields.push({
        title: jsonKey,
        value: jsonValue,
        short: true
      });
    }
    return this.slack.send({
      channel: this.channel,
      username: this.username,
      text: `${msg}`,
      icon_emoji: void 0,
      attachments: [
        {
          fields: fields
        }
      ]
    }, function(err) {
      if (err) {
        return cb(err, false);
      }
      return cb(null, true);
    });
  });
};

_getTimestamp = function() {
  var d;
  d = new Date();
  return d.toUTCString();
};

module.exports = Slack;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL2luZGV4LmpzIiwic291cmNlcyI6WyJsaWIvaW5kZXguY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsS0FBQSxFQUFBLENBQUEsRUFBQSxhQUFBLEVBQUEsRUFBQSxFQUFBLFdBQUEsRUFBQSxLQUFBLEVBQUEsSUFBQSxFQUFBOztBQUFBLENBQUEsR0FBYyxPQUFBLENBQVEsUUFBUjs7QUFDZCxJQUFBLEdBQWMsT0FBQSxDQUFRLE1BQVI7O0FBQ2QsT0FBQSxHQUFjLE9BQUEsQ0FBUSxTQUFSOztBQUNkLFdBQUEsR0FBYyxPQUFBLENBQVEsY0FBUjs7QUFDZCxLQUFBLEdBQWMsT0FBQSxDQUFRLE9BQVI7O0FBQ2QsRUFBQSxHQUFjLE9BQUEsQ0FBUSxJQUFSOztBQUVkLEtBQUEsR0FBUSxRQUFBLENBQUMsT0FBRCxDQUFBO0VBQ04sQ0FBQSxDQUFFLFlBQUQsSUFBQyxDQUFBLFVBQUYsRUFBZSxTQUFELElBQUMsQ0FBQSxPQUFmLEVBQXlCLFVBQUQsSUFBQyxDQUFBLFFBQXpCLEVBQW9DLE9BQUQsSUFBQyxDQUFBLEtBQXBDLEVBQTRDLEtBQUQsSUFBQyxDQUFBLEdBQTVDLEVBQWtELEtBQUQsSUFBQyxDQUFBLEdBQWxELEVBQXdELEtBQUQsSUFBQyxDQUFBLEdBQXhELENBQUEsR0FBK0QsT0FBL0Q7RUFDQSxLQUF1RCxPQUFPLENBQUMsVUFBL0Q7SUFBQSxNQUFNLElBQUksS0FBSixDQUFVLDhCQUFWLEVBQU47O0VBQ0EsS0FBZ0QsT0FBTyxDQUFDLEdBQXhEO0lBQUEsTUFBTSxJQUFJLEtBQUosQ0FBVSx1QkFBVixFQUFOOztFQUVBLElBQUMsQ0FBQSxLQUFELEdBQVMsV0FBQSxDQUFZLElBQUMsQ0FBQSxVQUFiO0FBTEg7O0FBUVIsSUFBSSxDQUFDLFFBQUwsQ0FBYyxLQUFkLEVBQXFCLE9BQU8sQ0FBQyxTQUE3Qjs7QUFDQSxPQUFPLENBQUMsVUFBVSxDQUFDLEtBQW5CLEdBQTJCOztBQUUzQixLQUFLLENBQUEsU0FBRSxD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LENBQUE7TUFDQSxJQUF5QixHQUF6QjtBQUFBLGVBQU8sRUFBQSxDQUFHLEdBQUgsRUFBUSxLQUFSLEVBQVA7O2FBQ0EsRUFBQSxDQUFHLElBQUgsRUFBUyxJQUFUO0lBRkEsQ0FWRjtFQTlDaUIsQ0FBbkI7QUFEVzs7QUFnRWIsYUFBQSxHQUFnQixRQUFBLENBQUEsQ0FBQTtBQUNoQixNQUFBO0VBQUUsQ0FBQSxHQUFJLElBQUksSUFBSixDQUFBO1NBQ0osQ0FBQyxDQUFDLFdBQUYsQ0FBQTtBQUZjOztBQUtoQixNQUFNLENBQUMsT0FBUCxHQUFpQiIsInNvdXJjZXNDb250ZW50IjpbIl8gICAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJylcbnV0aWwgICAgICAgID0gcmVxdWlyZSgndXRpbCcpXG53aW5zdG9uICAgICA9IHJlcXVpcmUoJ3dpbnN0b24nKVxuc2xhY2tOb3RpZnkgPSByZXF1aXJlKCdzbGFjay1ub3RpZnknKVxudXNhZ2UgICAgICAgPSByZXF1aXJlKCd1c2FnZScpXG5vcyAgICAgICAgICA9IHJlcXVpcmUoJ29zJylcblxuU2xhY2sgPSAob3B0aW9ucykgLT5cbiAge0B3ZWJIb29rVXJsLCBAY2hhbm5lbCwgQHVzZXJuYW1lLCBAbGV2ZWwsIEBwaWQsIEBlbnYsIEBhcHB9ID0gb3B0aW9uc1xuICB0aHJvdyBuZXcgRXJyb3IoJ3dlYkhvb2tVcmwgbXVzdCBiZSBzcGVjaWZpZWQnKSB1bmxlc3Mgb3B0aW9ucy53ZWJIb29rVXJsXG4gIHRocm93IG5ldyBFcnJvcigncGlkIG11c3QgYmUgc3BlY2lmaWVkJykgdW5sZXNzIG9wdGlvbnMucGlkXG5cbiAgQHNsYWNrID0gc2xhY2tOb3RpZnkgQHdlYkhvb2tVcmxcbiAgcmV0dXJuXG5cbnV0aWwuaW5oZXJpdHMgU2xhY2ssIHdpbnN0b24uVHJhbnNwb3J0XG53aW5zdG9uLnRyYW5zcG9ydHMuU2xhY2sgPSBTbGFja1xuXG5TbGFjazo6bG9nID0gKGxldmVsLCBtc2csIG1ldGEsIGNiKSAtPlxuICB1c2FnZS5sb29rdXAgQHBpZCwgKGVyciwgc3RhdCkgPT5cbiAgICBlcnJvclN0YWNrID0gKG1ldGEuZXJyb3JTdGFjaykudHJpbSgpIGlmIG1ldGEuZXJyb3JTdGFjaz9cbiAgICBtZXRhSnNvbiA9IG1ldGEuanNvbiA/IHt9XG4gICAgbXNnID0gXCIqI3ttc2d9KlwiXG5cbiAgICBpZiBlcnJvclN0YWNrP1xuICAgICAgZXJyb3JTdGFjayA9IGVycm9yU3RhY2sucmVwbGFjZSgvXFxyP1xcbnxcXHIvZywgJ1xcbicpXG4gICAgICBhcnJTdGFjayA9IGVycm9yU3RhY2suc3BsaXQoJ1xcbicpXG5cbiAgICAgIHBhcmFncmFwaCA9IGZhbHNlXG4gICAgICBzdHJTdGFjayA9IF8ubWFwKGFyclN0YWNrLCAodmFsLCBpbmRleCkgLT5cbiAgICAgICAgdmFsID0gdmFsLnRyaW0oKVxuICAgICAgICBpZiB2YWwuaW5kZXhPZignLmNvZmZlZScpID4gLTEgb3IgaW5kZXg9PTBcbiAgICAgICAgICByZXR1cm4gXCJgI3t2YWx9YFwiXG4gICAgICAgIGVsc2UgaWYgbm90IHBhcmFncmFwaFxuICAgICAgICAgIHBhcmFncmFwaCA9IHRydWVcbiAgICAgICAgICByZXR1cm4gXCJgYGAje3ZhbH1cIlxuICAgICAgICBlbHNlIGlmIGFyclN0YWNrW2luZGV4KzFdPyBhbmQgYXJyU3RhY2tbaW5kZXgrMV0uaW5kZXhPZignLmNvZmZlZScpID4gLTFcbiAgICAgICAgICBwYXJhZ3JhcGggPSBmYWxzZVxuICAgICAgICAgIHJldHVybiBcIiN7dmFsfWBgYFwiXG4gICAgICAgIGVsc2UgaWYgaW5kZXggPT0gYXJyU3RhY2subGVuZ3RoLTEgYW5kIHBhcmFncmFwaFxuICAgICAgICAgIHBhcmFncmFwaCA9IGZhbHNlXG4gICAgICAgICAgcmV0dXJuIFwiI3t2YWx9YGBgXCJcbiAgICAgICAgZWxzZVxuICAgICAgICAgIHBhcmFncmFwaCA9IHRydWVcbiAgICAgICAgICByZXR1cm4gXCIje3ZhbH1cIlxuICAgICAgICApLmpvaW4oJ1xcbicpXG4gICAgICBtc2cgKz0gXCJcXG4je3N0clN0YWNrfVwiXG5cbiAgICB1c2FnZUNwdSA9IHN0YXQuY3B1XG4gICAgdXNhZ2VNZW0gPSBzdGF0Lm1lbW9yeSAvICgxMDAwKjEwMDApXG4gICAgdG90YWxNZW0gPSBvcy50b3RhbG1lbSgpIC8gKDEwMDAqMTAwMClcbiAgICB1c2FnZU1lbVAgPSB1c2FnZU1lbS90b3RhbE1lbSAqIDEwMFxuXG4gICAgZmllbGRzID0gW1xuICAgICAgeyB0aXRsZTogJ0FwcE5hbWUnLCB2YWx1ZTogQGFwcCwgc2hvcnQ6IHRydWUgfSBpZiBAYXBwXG4gICAgICB7IHRpdGxlOiAnRW52TmFtZScsIHZhbHVlOiBAZW52LCBzaG9ydDogdHJ1ZSB9IGlmIEBlbnZcbiAgICAgIHsgdGl0bGU6ICdDUFUnLCB2YWx1ZTogXCIje3VzYWdlQ3B1LnRvRml4ZWQoMil9JVwiLCBzaG9ydDogdHJ1ZSB9IGlmIHN0YXQ/XG4gICAgICB7IHRpdGxlOiAnTUVNJywgdmFsdWU6IFwiI3t1c2FnZU1lbS50b0ZpeGVkKDIpfSAvICN7dG90YWxNZW0udG9GaXhlZCgyKX0gTUIgKCN7dXNhZ2VNZW1QLnRvRml4ZWQoMil9JSlcIiwgc2hvcnQ6IHRydWUgfSBpZiBzdGF0P1xuICAgICAgeyB0aXRsZTogJ1RpbWVzdGFtcCcsIHZhbHVlOiBfZ2V0VGltZXN0YW1wKCksIHNob3J0OiB0cnVlIH1cbiAgICAgIHsgdGl0bGU6ICdMZXZlbCcsIHZhbHVlOiBsZXZlbCwgc2hvcnQ6IHRydWUgfSBpZiBsZXZlbFxuICAgIF1cblxuICAgIGZvciBqc29uS2V5LCBqc29uVmFsdWUgb2YgbWV0YUpzb25cbiAgICAgIGZpZWxkcy5wdXNoIHsgdGl0bGU6IGpzb25LZXksIHZhbHVlOiBqc29uVmFsdWUsIHNob3J0OiB0cnVlIH1cblxuICAgIEBzbGFjay5zZW5kXG4gICAgICBjaGFubmVsOiAgICBAY2hhbm5lbFxuICAgICAgdXNlcm5hbWU6ICAgQHVzZXJuYW1lXG4gICAgICB0ZXh0OiAgICAgICBcIiN7bXNnfVwiXG4gICAgICBpY29uX2Vtb2ppOiB1bmRlZmluZWRcbiAgICAgIGF0dGFjaG1lbnRzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBmaWVsZHM6IGZpZWxkc1xuICAgICAgICB9XG4gICAgICBdXG4gICAgLCAoZXJyKSAtPlxuICAgICAgcmV0dXJuIGNiKGVyciwgZmFsc2UpIGlmIGVyclxuICAgICAgY2IobnVsbCwgdHJ1ZSlcblxuICByZXR1cm5cblxuXG5fZ2V0VGltZXN0YW1wID0gKCkgLT5cbiAgZCA9IG5ldyBEYXRlKClcbiAgZC50b1VUQ1N0cmluZygpXG5cblxubW9kdWxlLmV4cG9ydHMgPSBTbGFja1xuIl19
